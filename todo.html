<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TMF Task Manager</title>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

/* ===========================
   1. RESET & CUSTOM PROPERTIES
   =========================== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --sidebar-width: 260px;
  --bg: #f8f9fc;
  --bg-secondary: #f0f2f5;
  --sidebar-bg: rgba(20, 20, 28, 0.92);
  --sidebar-text: rgba(255, 255, 255, 0.55);
  --sidebar-active: #6366f1;
  --sidebar-hover: rgba(255,255,255,0.06);
  --card-bg: rgba(255, 255, 255, 0.8);
  --card-bg-solid: #ffffff;
  --text: #1a1a2e;
  --text-secondary: #6b7280;
  --text-tertiary: #9ca3af;
  --accent: #6366f1;
  --accent-hover: #4f46e5;
  --accent-light: rgba(99, 102, 241, 0.08);
  --accent-glow: rgba(99, 102, 241, 0.2);
  --border: rgba(0, 0, 0, 0.08);
  --border-light: rgba(0, 0, 0, 0.04);
  --priority-urgent: #dc2626;
  --priority-high: #ef4444;
  --priority-medium: #f59e0b;
  --priority-low: #22c55e;
  --status-todo: #94a3b8;
  --status-inprogress: #6366f1;
  --status-review: #f59e0b;
  --status-done: #22c55e;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.03), 0 1px 3px rgba(0,0,0,0.02);
  --shadow: 0 2px 4px rgba(0,0,0,0.03), 0 4px 12px rgba(0,0,0,0.04);
  --shadow-lg: 0 8px 24px rgba(0,0,0,0.06), 0 4px 8px rgba(0,0,0,0.04);
  --shadow-xl: 0 16px 48px rgba(0,0,0,0.08), 0 8px 16px rgba(0,0,0,0.04);
  --shadow-accent: 0 4px 14px rgba(99, 102, 241, 0.25);
  --glass-bg: rgba(255, 255, 255, 0.6);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-blur: 20px;
  --transition: 0.2s ease;
  --transition-slow: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-spring: 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  --radius: 12px;
  --radius-sm: 8px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  --radius-pill: 980px;
  --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
}

[data-theme="dark"] {
  --bg: #0f0f17;
  --bg-secondary: #16161f;
  --sidebar-bg: rgba(15, 15, 23, 0.95);
  --sidebar-text: rgba(255, 255, 255, 0.45);
  --sidebar-active: #818cf8;
  --sidebar-hover: rgba(255, 255, 255, 0.06);
  --card-bg: rgba(30, 30, 42, 0.8);
  --card-bg-solid: #1e1e2a;
  --text: #e5e7eb;
  --text-secondary: #9ca3af;
  --text-tertiary: #6b7280;
  --accent: #818cf8;
  --accent-hover: #6366f1;
  --accent-light: rgba(129, 140, 248, 0.1);
  --accent-glow: rgba(129, 140, 248, 0.15);
  --border: rgba(255, 255, 255, 0.08);
  --border-light: rgba(255, 255, 255, 0.04);
  --glass-bg: rgba(30, 30, 42, 0.6);
  --glass-border: rgba(255, 255, 255, 0.08);
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.2);
  --shadow: 0 2px 4px rgba(0,0,0,0.2), 0 4px 12px rgba(0,0,0,0.15);
  --shadow-lg: 0 8px 24px rgba(0,0,0,0.3), 0 4px 8px rgba(0,0,0,0.2);
  --shadow-xl: 0 16px 48px rgba(0,0,0,0.4);
  --shadow-accent: 0 4px 14px rgba(129, 140, 248, 0.2);
}

/* ===========================
   2. BASE
   =========================== */
body {
  font-family: var(--font-family);
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  display: flex;
  overflow: hidden;
  font-size: 14px;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  letter-spacing: -0.011em;
  transition: background var(--transition-slow), color var(--transition-slow);
}

/* ===========================
   3. SIDEBAR
   =========================== */
.sidebar {
  width: var(--sidebar-width);
  min-width: var(--sidebar-width);
  background: var(--sidebar-bg);
  backdrop-filter: blur(var(--glass-blur));
  -webkit-backdrop-filter: blur(var(--glass-blur));
  color: var(--sidebar-text);
  display: flex;
  flex-direction: column;
  user-select: none;
  border-right: 1px solid rgba(255,255,255,0.06);
  transition: transform var(--transition-slow);
  z-index: 100;
}

.sidebar-brand {
  padding: 24px 20px 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 15px;
  font-weight: 700;
  color: #fff;
  letter-spacing: -0.02em;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}

.sidebar-brand svg { flex-shrink: 0; opacity: 0.9; }

.sidebar-nav {
  flex: 1;
  overflow-y: auto;
  padding: 8px 0;
}

.nav-item {
  padding: 7px 14px;
  margin: 2px 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  font-weight: 500;
  letter-spacing: -0.01em;
  transition: all var(--transition);
  color: var(--sidebar-text);
  border: none;
  background: none;
  width: calc(100% - 16px);
  text-align: left;
  border-radius: var(--radius-sm);
}

.nav-item:hover { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.85); }
.nav-item.active { background: rgba(99,102,241,0.2); color: var(--sidebar-active); }
.nav-item .nav-icon { width: 18px; text-align: center; font-size: 14px; flex-shrink: 0; }
.nav-item .nav-label { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.nav-item .badge {
  background: rgba(255,255,255,0.1);
  border-radius: var(--radius-pill);
  padding: 1px 7px;
  font-size: 10.5px;
  min-width: 20px;
  text-align: center;
  font-weight: 600;
}
.nav-item.active .badge { background: rgba(99,102,241,0.25); }

.nav-section {
  padding: 20px 16px 8px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: rgba(255,255,255,0.3);
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
}

.nav-section .toggle-arrow {
  font-size: 10px;
  transition: transform var(--transition);
}

.nav-section .toggle-arrow.collapsed { transform: rotate(-90deg); }

.nav-children { overflow: hidden; }
.nav-children.collapsed { display: none; }
.nav-children .nav-item { padding-left: 32px; font-size: 13px; }

.sidebar-footer {
  border-top: 1px solid rgba(255,255,255,0.06);
  padding: 8px 0 12px;
}

.sidebar-footer .nav-item { color: var(--accent); font-weight: 500; }

/* ===========================
   4. MAIN LAYOUT
   =========================== */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-width: 0;
}

.main-header {
  padding: 14px 32px;
  display: flex;
  align-items: center;
  gap: 16px;
  border-bottom: 1px solid var(--border);
  background: var(--glass-bg);
  backdrop-filter: blur(var(--glass-blur));
  -webkit-backdrop-filter: blur(var(--glass-blur));
  flex-shrink: 0;
}

.view-title { font-size: 22px; font-weight: 700; white-space: nowrap; letter-spacing: -0.03em; }

.header-spacer { flex: 1; }

.search-box {
  position: relative;
  width: 240px;
}

.search-box input {
  width: 100%;
  padding: 9px 14px 9px 36px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-family: inherit;
  outline: none;
  background: var(--bg-secondary);
  color: var(--text);
  transition: border-color var(--transition), box-shadow var(--transition), background var(--transition);
}

.search-box input:focus { border-color: var(--accent); background: var(--card-bg-solid); box-shadow: 0 0 0 3px var(--accent-glow); }

.search-box .search-icon {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-tertiary);
  pointer-events: none;
  font-size: 14px;
}

.view-toggles { display: flex; gap: 2px; background: var(--bg-secondary); border-radius: var(--radius-sm); padding: 3px; }

.view-toggle-btn {
  padding: 6px 16px;
  border: none;
  border-radius: 6px;
  background: transparent;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  color: var(--text-secondary);
  transition: all var(--transition);
  font-family: inherit;
}

.view-toggle-btn:hover { color: var(--text); }
.view-toggle-btn.active { background: var(--card-bg-solid); color: var(--text); font-weight: 600; box-shadow: var(--shadow-sm); }

/* Filter bar */
.filter-bar {
  padding: 10px 32px;
  display: flex;
  gap: 8px;
  align-items: center;
  border-bottom: 1px solid var(--border);
  background: var(--bg-secondary);
  flex-shrink: 0;
  flex-wrap: wrap;
}

.filter-bar label {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-right: 2px;
}

.filter-bar select {
  padding: 6px 10px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 12.5px;
  font-family: inherit;
  outline: none;
  background: var(--card-bg-solid);
  color: var(--text);
  cursor: pointer;
  transition: border-color var(--transition), box-shadow var(--transition);
}

.filter-bar select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

/* ===========================
   5. MAIN CONTENT AREA
   =========================== */
.main-content {
  flex: 1;
  overflow-y: auto;

  padding: 28px 32px;
}

/* ===========================
   6. TASK CARDS (List View)
   =========================== */
.task-group-title {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  padding: 16px 0 6px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.task-group-title .group-count { font-weight: 400; color: var(--text-tertiary); }

.task-card {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 14px 18px;
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: var(--radius);
  margin-top: 6px;
  box-shadow: var(--shadow-sm);
  cursor: pointer;
  transition: box-shadow var(--transition), transform var(--transition-spring);
  border: 1px solid var(--border);
  animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.task-card:hover { box-shadow: var(--shadow); transform: translateY(-2px); }

.task-card.done-task .task-title { text-decoration: line-through; color: var(--text-secondary); }

.task-check {
  width: 20px;
  height: 20px;
  min-width: 20px;
  border: 2px solid var(--text-tertiary);
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  margin-top: 2px;
  flex-shrink: 0;
}

.task-check:hover { border-color: var(--status-done); background: rgba(34,197,94,0.08); }
.task-check.checked { background: var(--status-done); border-color: var(--status-done); }
.task-check.checked::after {
  content: '';
  width: 5px;
  height: 9px;
  border: solid #fff;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
  margin-bottom: 2px;
}

.task-body { flex: 1; min-width: 0; }
.task-title { font-size: 14px; font-weight: 500; line-height: 1.4; word-break: break-word; }

.task-meta {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 4px;
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

.task-client-tag {
  background: var(--accent-light);
  color: var(--accent);
  padding: 2px 9px;
  border-radius: var(--radius-pill);
  font-size: 11px;
  font-weight: 600;
  white-space: nowrap;
}

.task-category-pill {
  background: var(--border-light);
  color: var(--text-secondary);
  padding: 2px 9px;
  border-radius: var(--radius-pill);
  font-size: 11px;
  font-weight: 500;
}

.task-due { display: flex; align-items: center; gap: 3px; font-size: 11.5px; }
.task-due.overdue { color: var(--priority-high); font-weight: 600; }
.task-due.soon { color: var(--priority-medium); font-weight: 600; }

.task-card .avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 10.5px;
  font-weight: 700;
  flex-shrink: 0;
  margin-top: 2px;
}

.task-card .task-actions {
  display: flex;
  gap: 2px;
  opacity: 0;
  transition: opacity var(--transition);
}

.task-card:hover .task-actions { opacity: 1; }

.icon-btn {
  width: 28px;
  height: 28px;
  border: none;
  background: none;
  border-radius: var(--radius-sm);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
  transition: all var(--transition);
  font-size: 14px;
}

.icon-btn:hover { background: var(--border-light); }
.icon-btn.danger:hover { background: rgba(239,68,68,0.08); color: var(--priority-high); }

/* Priority badge */
.priority-badge {
  padding: 2px 8px 2px 18px;
  border-radius: var(--radius-pill);
  font-size: 10.5px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  position: relative;
  background: transparent;
}
.priority-badge::before {
  content: '';
  position: absolute;
  left: 6px;
  top: 50%;
  transform: translateY(-50%);
  width: 6px;
  height: 6px;
  border-radius: 50%;
}

.priority-badge.urgent { color: var(--priority-urgent); }
.priority-badge.urgent::before { background: var(--priority-urgent); }
.priority-badge.high { color: var(--priority-high); }
.priority-badge.high::before { background: var(--priority-high); }
.priority-badge.medium { color: var(--priority-medium); }
.priority-badge.medium::before { background: var(--priority-medium); }
.priority-badge.low { color: var(--priority-low); }
.priority-badge.low::before { background: var(--priority-low); }

/* Status badge */
.status-badge {
  padding: 3px 10px;
  border-radius: var(--radius-pill);
  font-size: 11px;
  font-weight: 600;
}

.status-badge.todo { background: rgba(148,163,184,0.1); color: var(--status-todo); }
.status-badge.inprogress { background: rgba(99,102,241,0.1); color: var(--status-inprogress); }
.status-badge.review { background: rgba(245,158,11,0.1); color: var(--status-review); }
.status-badge.done { background: rgba(34,197,94,0.1); color: var(--status-done); }

/* Client status badge */
.client-status-badge {
  padding: 3px 10px;
  border-radius: var(--radius-pill);
  font-size: 11px;
  font-weight: 600;
  display: inline-block;
}

/* ===========================
   7. BOARD VIEW (KANBAN)
   =========================== */
.board {
  display: flex;
  gap: 20px;
  height: 100%;
  min-height: 0;
  overflow-x: auto;
  padding-bottom: 8px;
}

.board-column {
  background: var(--bg-secondary);
  border-radius: var(--radius-lg);
  display: flex;
  flex-direction: column;
  min-height: 0;
  min-width: 280px;
  max-width: 320px;
  flex-shrink: 0;
  border: 1px solid var(--border);
}

.board-col-header {
  padding: 16px 16px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-weight: 600;
  font-size: 13px;
}

.board-col-header .col-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  margin-right: 8px;
  display: inline-block;
}

.board-col-header .col-count {
  background: rgba(0,0,0,0.08);
  border-radius: var(--radius-pill);
  padding: 1px 8px;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary);
}

.board-col-body {
  flex: 1;
  overflow-y: auto;
  padding: 0 12px 12px;
  min-height: 60px;
}

.board-card {
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: var(--radius);
  padding: 14px;
  margin-bottom: 10px;
  box-shadow: var(--shadow-sm);
  cursor: pointer;
  transition: box-shadow var(--transition), transform var(--transition-spring);
  border: 1px solid var(--border);
}

.board-card:hover { box-shadow: var(--shadow); transform: translateY(-2px); }

.board-card-title { font-size: 13px; font-weight: 500; margin-bottom: 8px; line-height: 1.3; }
.board-card-meta { display: flex; align-items: center; justify-content: space-between; font-size: 11px; color: var(--text-secondary); }
.board-card-category { font-size: 10px; padding: 2px 8px; border-radius: var(--radius-pill); background: var(--accent-light); color: var(--accent); font-weight: 600; display: inline-block; }

.board-col-add-btn {
  width: 100%;
  padding: 10px;
  border: 1.5px dashed var(--border);
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-secondary);
  font-size: 13px;
  cursor: pointer;
  margin-bottom: 8px;
  transition: all var(--transition);
  font-family: inherit;
}
.board-col-add-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
  background: var(--accent-light);
}

/* Weekly Timeline */
.weekly-timeline { margin-top: 24px; }
.timeline-section { margin-bottom: 20px; }
.timeline-section-header {
  font-size: 14px;
  font-weight: 700;
  padding: 10px 0 6px;
  display: flex;
  align-items: center;
  gap: 8px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 8px;
}
.timeline-section-header .section-count {
  font-weight: 400;
  color: var(--text-secondary);
  font-size: 12px;
}
.timeline-section-header.overdue { color: var(--priority-high); }
.timeline-section-header.today { color: var(--status-inprogress); }
.timeline-section-header.week { color: var(--priority-medium); }
.timeline-section-header.upcoming { color: var(--text-secondary); }

.header-add-btn {
  padding: 8px 16px;
  border: none;
  border-radius: var(--radius-sm);
  background: var(--accent);
  color: #fff;
  font-size: 13px;
  font-weight: 600;
  font-family: inherit;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all var(--transition);
  white-space: nowrap;
  box-shadow: var(--shadow-accent);
}
.header-add-btn:hover { background: var(--accent-hover); box-shadow: 0 6px 20px rgba(99,102,241,0.3); transform: translateY(-1px); }

/* Board card checkbox */
.board-card-check {
  width: 18px;
  height: 18px;
  border: 2px solid var(--border);
  border-radius: 50%;
  cursor: pointer;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
  font-size: 10px;
  color: transparent;
  margin-top: 1px;
}
.board-card-check:hover { border-color: var(--status-done); }
.board-card-check.checked {
  background: var(--status-done);
  border-color: var(--status-done);
  color: #fff;
}
.board-card.done-task .board-card-title {
  text-decoration: line-through;
  opacity: 0.5;
}
.board-card.done-task { opacity: 0.6; }

/* Subtask styles in modal */
.subtask-section {
  margin-top: 16px;
  border-top: 1px solid var(--border);
  padding-top: 12px;
}
.subtask-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.subtask-header h4 { font-size: 13px; font-weight: 700; }
.subtask-progress { font-size: 12px; color: var(--text-secondary); }

.subtask-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 7px 0;
  border-bottom: 1px solid var(--border-light);
}
.subtask-check {
  width: 16px;
  height: 16px;
  border: 2px solid var(--border);
  border-radius: 6px;
  cursor: pointer;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  color: transparent;
  transition: all 0.15s;
}
.subtask-check:hover { border-color: var(--status-done); }
.subtask-check.checked {
  background: var(--status-done);
  border-color: var(--status-done);
  color: #fff;
}
.subtask-row.completed .subtask-title {
  text-decoration: line-through;
  color: var(--text-secondary);
}
.subtask-title { flex: 1; font-size: 13px; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.subtask-link { color: var(--accent); font-size: 12px; text-decoration: none; flex-shrink: 0; }
.subtask-link:hover { text-decoration: underline; }
.subtask-assignee { font-size: 11px; color: var(--text-secondary); flex-shrink: 0; white-space: nowrap; }
.subtask-due { font-size: 11px; color: var(--text-secondary); flex-shrink: 0; white-space: nowrap; }
.subtask-delete { cursor: pointer; color: var(--text-secondary); font-size: 12px; flex-shrink: 0; padding: 0 2px; }
.subtask-delete:hover { color: var(--priority-high); }

.add-subtask-btn {
  width: 100%;
  padding: 6px;
  margin-top: 6px;
  border: 1px dashed var(--border);
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-secondary);
  font-size: 12px;
  cursor: pointer;
  font-family: inherit;
}
.add-subtask-btn:hover { border-color: var(--accent); color: var(--accent); }

/* Board card subtask progress */
.board-card-subtasks {
  font-size: 10px;
  color: var(--text-secondary);
  display: inline-flex;
  align-items: center;
  gap: 3px;
  padding: 1px 6px;
  border-radius: var(--radius-pill);
  background: var(--border-light);
}
.board-card-subtasks .st-done { color: var(--status-done); font-weight: 600; }
.board-card-subtasks { cursor: pointer; }
.board-card-subtasks:hover { background: var(--border); }

/* Board card inline subtask list (expanded) */
.board-card-subtask-list {
  margin-top: 6px;
  padding-top: 6px;
  border-top: 1px solid var(--border-light);
}
.board-card-st-row {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 3px 0;
  font-size: 11px;
}
.board-card-st-check {
  width: 14px;
  height: 14px;
  border: 1.5px solid var(--border);
  border-radius: 3px;
  cursor: pointer;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 8px;
  color: transparent;
  transition: all 0.15s;
}
.board-card-st-check:hover { border-color: var(--status-done); }
.board-card-st-check.checked {
  background: var(--status-done);
  border-color: var(--status-done);
  color: #fff;
}
.board-card-st-row.completed .board-card-st-title {
  text-decoration: line-through;
  color: var(--text-secondary);
}
.board-card-st-title {
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Board column completed section */
.board-completed-toggle {
  padding: 8px 6px;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  border-top: 1px dashed var(--border);
  margin-top: 4px;
}
.board-completed-toggle:hover { color: var(--accent); }

/* Team member view task card subtask list */
.atty-subtask-list {
  margin: 4px 0 8px 32px;
  padding: 6px 0 6px 12px;
  border-left: 2px solid var(--border);
}
.atty-st-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 0;
  font-size: 12px;
}
.atty-st-check {
  width: 15px;
  height: 15px;
  border: 1.5px solid var(--border);
  border-radius: 3px;
  cursor: pointer;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 9px;
  color: transparent;
  transition: all 0.15s;
}
.atty-st-check:hover { border-color: var(--status-done); }
.atty-st-check.checked {
  background: var(--status-done);
  border-color: var(--status-done);
  color: #fff;
}
.atty-st-row.completed .atty-st-title {
  text-decoration: line-through;
  color: var(--text-secondary);
}
.atty-st-title { flex: 1; font-size: 12px; }
.atty-st-link { color: var(--accent); font-size: 11px; text-decoration: none; flex-shrink: 0; }
.atty-st-link:hover { text-decoration: underline; }
.atty-st-due { font-size: 11px; color: var(--text-secondary); flex-shrink: 0; }
.atty-st-assignee { font-size: 11px; color: var(--text-secondary); flex-shrink: 0; }

/* Delete buttons */
.delete-btn {
  opacity: 0;
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 13px;
  padding: 2px 4px;
  border-radius: 6px;
  transition: all var(--transition);
  flex-shrink: 0;
  line-height: 1;
}
.delete-btn:hover { color: var(--priority-high); background: rgba(239,68,68,0.08); }
.board-col-header:hover .delete-btn,
.nav-item:hover .delete-btn { opacity: 1; }
.board-col-header .header-right { display: flex; align-items: center; gap: 6px; }

.board-card .avatar {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 9px;
  font-weight: 700;
}

/* ===========================
   8. CALENDAR VIEW
   =========================== */
.calendar-nav {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 20px;
}

.calendar-nav .month-label { font-size: 18px; font-weight: 600; min-width: 180px; letter-spacing: -0.02em; }

.cal-nav-btn {
  width: 34px;
  height: 34px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--card-bg);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  color: var(--text-secondary);
  transition: all var(--transition);
}

.cal-nav-btn:hover { border-color: var(--accent); color: var(--accent); }

.today-btn {
  padding: 6px 16px;
  border: 1px solid var(--border);
  border-radius: var(--radius-pill);
  background: var(--card-bg);
  font-size: 12.5px;
  font-weight: 600;
  cursor: pointer;
  color: var(--text-secondary);
  font-family: inherit;
  transition: all var(--transition);
}

.today-btn:hover { border-color: var(--accent); color: var(--accent); }

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  background: var(--border);
  gap: 1px;
}

.cal-day-header {
  background: var(--bg-secondary);
  padding: 8px;
  text-align: center;
  font-size: 11.5px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
}

.cal-day {
  background: var(--card-bg-solid);
  min-height: 100px;
  padding: 8px;
  cursor: pointer;
  transition: background var(--transition);
  position: relative;
}

.cal-day:hover { background: var(--bg-secondary); }
.cal-day.today { background: var(--accent-light); }
.cal-day.other-month { opacity: 0.4; }

.cal-day .day-num {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 4px;
}

.cal-day.today .day-num {
  background: var(--accent);
  color: #fff;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
}

.cal-task-pill {
  padding: 2px 7px;
  border-radius: var(--radius-pill);
  font-size: 10.5px;
  margin-bottom: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  cursor: pointer;
  font-weight: 500;
  transition: opacity var(--transition);
}

.cal-task-pill:hover { opacity: 0.8; }
.cal-task-pill.urgent, .cal-task-pill.high { background: rgba(239,68,68,0.1); color: var(--priority-high); }
.cal-task-pill.medium { background: rgba(245,158,11,0.1); color: #92400e; }
.cal-task-pill.low { background: rgba(34,197,94,0.1); color: #065f46; }

.cal-more { font-size: 10px; color: var(--accent); font-weight: 600; cursor: pointer; padding: 1px 4px; }

/* ===========================
   9. DASHBOARD
   =========================== */
.stats-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
  gap: 16px;
  margin-bottom: 28px;
}

.stat-card {
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: var(--radius-lg);
  padding: 22px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border);
  transition: transform var(--transition-spring), box-shadow var(--transition);
}
.stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }

.stat-card .stat-value { font-size: 28px; font-weight: 700; line-height: 1.1; letter-spacing: -0.03em; }
.stat-card .stat-label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; font-weight: 500; }
.stat-card.accent .stat-value { color: var(--accent); }
.stat-card.danger .stat-value { color: var(--priority-high); }
.stat-card.warning .stat-value { color: var(--priority-medium); }
.stat-card.success .stat-value { color: var(--status-done); }

.dashboard-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
}

.dash-section {
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
  border: 1px solid var(--border);
}

.dash-section-header {
  padding: 16px 20px;
  font-weight: 600;
  font-size: 14px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 8px;
}

.dash-section-body { padding: 8px 0; max-height: 340px; overflow-y: auto; }

.deadline-item {
  padding: 10px 18px;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: background var(--transition);
  cursor: pointer;
}

.deadline-item:hover { background: var(--border-light); }

.deadline-item .dl-info { flex: 1; min-width: 0; }
.deadline-item .dl-title { font-size: 13px; font-weight: 500; }
.deadline-item .dl-client { font-size: 11.5px; color: var(--text-secondary); }
.deadline-item .dl-date { font-size: 12px; font-weight: 600; white-space: nowrap; }
.deadline-item .dl-date.overdue { color: var(--priority-high); }
.deadline-item .dl-date.soon { color: var(--priority-medium); }

.sol-item {
  padding: 10px 18px;
  display: flex;
  align-items: center;
  gap: 12px;
  border-left: 4px solid transparent;
  transition: background var(--transition);
  cursor: pointer;
}

.sol-item:hover { background: var(--border-light); }
.sol-item.critical { border-left-color: var(--priority-high); }
.sol-item.warning { border-left-color: var(--priority-medium); }
.sol-item.caution { border-left-color: #f97316; }

.sol-item .sol-info { flex: 1; }
.sol-item .sol-name { font-size: 13px; font-weight: 600; }
.sol-item .sol-case { font-size: 11.5px; color: var(--text-secondary); }
.sol-item .sol-days { font-size: 12px; font-weight: 700; white-space: nowrap; }

/* ===========================
   10. CLIENT SUMMARY CARD
   =========================== */
.client-summary {
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: var(--radius-lg);
  padding: 26px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border);
}

.client-summary-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

.client-summary-header h2 { font-size: 20px; font-weight: 600; letter-spacing: -0.02em; }

.client-summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 14px;
}

.cs-field .cs-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); font-weight: 600; margin-bottom: 2px; }
.cs-field .cs-value { font-size: 14px; font-weight: 500; }

.sol-alert {
  margin-top: 16px;
  padding: 12px 16px;
  border-radius: var(--radius);
  font-size: 13px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.sol-alert.critical { background: rgba(239,68,68,0.06); color: var(--priority-high); border: 1px solid rgba(239,68,68,0.2); }
.sol-alert.warning { background: rgba(245,158,11,0.06); color: #92400e; border: 1px solid rgba(245,158,11,0.2); }
.sol-alert.caution { background: rgba(249,115,22,0.06); color: #9a3412; border: 1px solid rgba(249,115,22,0.2); }

/* ===========================
   11. TEAM MEMBER VIEW
   =========================== */
.attorney-info-card {
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: var(--radius-lg);
  padding: 26px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-sm);
  display: flex;
  align-items: center;
  gap: 20px;
  border: 1px solid var(--border);
}

.attorney-info-card .avatar-lg {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 20px;
  font-weight: 700;
  flex-shrink: 0;
}

.attorney-info-card .atty-details h2 { font-size: 20px; font-weight: 600; }
.attorney-info-card .atty-details .atty-role { font-size: 13px; color: var(--text-secondary); }

.workload-stats {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
}

.workload-stat {
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 14px 20px;
  box-shadow: var(--shadow-sm);
  text-align: center;
  min-width: 100px;
  border: 1px solid var(--border);
}

.workload-stat .ws-val { font-size: 22px; font-weight: 700; }
.workload-stat .ws-label { font-size: 11px; color: var(--text-secondary); font-weight: 500; }

/* ===========================
   12. MODALS
   =========================== */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 500;
  display: none;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}

.modal-backdrop.open { display: flex; }

.modal {
  background: var(--card-bg-solid);
  border-radius: var(--radius-xl);
  width: 90%;
  max-width: 560px;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: var(--shadow-xl);
  animation: modalIn 0.3s cubic-bezier(0.32, 0.72, 0, 1);
  border: 1px solid var(--border);
}

@keyframes modalIn { from { opacity: 0; transform: scale(0.97) translateY(6px); } to { opacity: 1; transform: scale(1) translateY(0); } }

.modal-header {
  padding: 20px 24px;
  border-bottom: 1px solid rgba(210,210,215,0.4);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: var(--card-bg-solid);
  border-radius: var(--radius-xl) var(--radius-xl) 0 0;
  z-index: 1;
}

.modal-header h3 { font-size: 17px; font-weight: 600; letter-spacing: -0.01em; }

.modal-close {
  width: 30px;
  height: 30px;
  border: none;
  background: var(--bg-secondary);
  border-radius: 50%;
  cursor: pointer;
  font-size: 14px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition);
}

.modal-close:hover { background: var(--border); color: var(--text); }

.modal-body { padding: 22px 24px; }

.modal-footer {
  padding: 16px 24px;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-footer .footer-right { display: flex; gap: 8px; }

/* ===========================
   13. FORM ELEMENTS
   =========================== */
.form-group { margin-bottom: 14px; }

.form-label {
  display: block;
  font-size: 12.5px;
  font-weight: 600;
  margin-bottom: 4px;
  color: var(--text);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.form-input, .form-select, .form-textarea {
  width: 100%;
  padding: 10px 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 14px;
  font-family: inherit;
  outline: none;
  transition: border-color var(--transition), box-shadow var(--transition), background var(--transition);
  background: var(--bg-secondary);
  color: var(--text);
}

.form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); background: var(--card-bg-solid); box-shadow: 0 0 0 3px var(--accent-glow); }
.form-textarea { resize: vertical; min-height: 70px; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

.btn {
  padding: 10px 20px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all var(--transition);
  font-family: inherit;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.btn-primary { background: var(--accent); color: #fff; box-shadow: var(--shadow-accent); }
.btn-primary:hover { background: var(--accent-hover); box-shadow: 0 6px 20px rgba(99,102,241,0.3); transform: translateY(-1px); }
.btn-secondary { background: var(--bg-secondary); color: var(--text); }
.btn-secondary:hover { background: var(--border); }
.btn-danger { background: rgba(239,68,68,0.08); color: var(--priority-high); }
.btn-danger:hover { background: rgba(239,68,68,0.15); }
.btn-sm { padding: 6px 14px; font-size: 12px; }

/* ===========================
   14. EMPTY STATE
   =========================== */
.empty-state {
  text-align: center;
  padding: 80px 24px;
  color: var(--text-secondary);
}

.empty-state .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; color: var(--text-tertiary); }
.empty-state h3 { font-size: 18px; margin-bottom: 8px; color: var(--text); font-weight: 600; letter-spacing: -0.02em; }
.empty-state p { font-size: 14px; color: var(--text-secondary); }

/* ===========================
   15. TOAST & CONTEXT MENU
   =========================== */
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--card-bg-solid);
  color: var(--text);
  padding: 12px 24px;
  border-radius: var(--radius);
  font-size: 13.5px;
  font-weight: 500;
  z-index: 1000;
  transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  pointer-events: none;
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--border);
}

.toast.show { transform: translateX(-50%) translateY(0); }


/* ===========================
   16. ANIMATIONS & SCROLLBAR
   =========================== */
@keyframes slideIn {
  from { opacity: 0; transform: translateY(-6px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Staggered card entry */
.task-card:nth-child(1) { animation-delay: 0ms; }
.task-card:nth-child(2) { animation-delay: 30ms; }
.task-card:nth-child(3) { animation-delay: 60ms; }
.task-card:nth-child(4) { animation-delay: 90ms; }
.task-card:nth-child(5) { animation-delay: 120ms; }
.task-card:nth-child(n+6) { animation-delay: 150ms; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-tertiary); }
* { scrollbar-width: thin; scrollbar-color: var(--border) transparent; }

/* Mobile menu button */
.mobile-menu-btn {
  display: none;
  position: fixed;
  top: 14px;
  left: 14px;
  z-index: 200;
  width: 40px;
  height: 40px;
  border: none;
  border-radius: var(--radius-sm);
  background: var(--card-bg-solid);
  box-shadow: var(--shadow);
  cursor: pointer;
  align-items: center;
  justify-content: center;
  color: var(--text);
}

.sidebar-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.3);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  z-index: 90;
}
.sidebar-overlay.show { display: block; }

/* Tablet: <= 1024px */
@media (max-width: 1024px) {
  .board { flex-wrap: wrap; }
  .board-column { min-width: 250px; max-width: none; flex: 1 1 250px; }
  .dashboard-grid { grid-template-columns: 1fr; }
  .main-header { padding: 14px 20px; }
  .main-content { padding: 20px; }
  .filter-bar { padding: 10px 20px; }
}

/* Mobile: <= 768px */
@media (max-width: 768px) {
  .mobile-menu-btn { display: flex; }

  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    transform: translateX(-100%);
    z-index: 100;
  }
  .sidebar.open { transform: translateX(0); }

  .main-header { padding: 14px 16px 14px 60px; }
  .main-content { padding: 16px; }
  .filter-bar { padding: 8px 16px; }

  .search-box { width: 100%; }
  .view-title { font-size: 18px; }

  .stats-row { grid-template-columns: repeat(2, 1fr); }
  .client-summary-grid { grid-template-columns: 1fr; }
  .form-row { grid-template-columns: 1fr; }

  .board { flex-direction: column; }
  .board-column { min-width: 100%; max-width: 100%; }

  .calendar-grid { font-size: 11px; }
  .cal-day { min-height: 70px; padding: 4px; }

  .workload-stats { flex-wrap: wrap; }
  .workload-stat { flex: 1 1 calc(50% - 6px); }
}
</style>
</head>
<body>

<button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileSidebar()">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
    <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
  </svg>
</button>

<nav class="sidebar">
  <div class="sidebar-brand">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 12l2 2 4-4"/></svg>
    TMF Task Manager
  </div>
  <div class="sidebar-nav" id="sidebarNav"></div>
  <div class="sidebar-footer" id="sidebarFooter"></div>
</nav>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileSidebar()"></div>

<div class="main">
  <div class="main-header" id="mainHeader"></div>
  <div id="filterBar"></div>
  <div class="main-content" id="mainContent"></div>
</div>

<div class="modal-backdrop" id="modalBackdrop" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modal"></div>
</div>

<div class="toast" id="toast"></div>

<script>
// =========================================
// 0. FIREBASE INIT
// =========================================
const firebaseConfig = {
  apiKey: "AIzaSyD5iHR0flHL4MDxzpMttCcYzAU-OtSKESg",
  authDomain: "teams-task-project.firebaseapp.com",
  projectId: "teams-task-project",
  storageBucket: "teams-task-project.firebasestorage.app",
  messagingSenderId: "182249850313",
  appId: "1:182249850313:web:22ac6d856fd9f09b761418",
  measurementId: "G-GL7GNJFDY0"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Firestore collection references
const COLLECTIONS = ['clients','attorneys','staff','tasks'];

// =========================================
// 1. CONSTANTS
// =========================================
const CASE_TYPES = ['Auto Accident','Slip & Fall','Medical Malpractice','Workers Comp','Product Liability','Wrongful Death','Dog Bite','Premises Liability','Other'];
const CLIENT_STATUSES = ['Intake','Active','Discovery','Negotiation','Litigation','Settled','Closed'];
const CLIENT_STATUS_COLORS = {Intake:'#8b5cf6',Active:'#3b82f6',Discovery:'#f59e0b',Negotiation:'#f97316',Litigation:'#ef4444',Settled:'#10b981',Closed:'#6b7280'};
const TASK_STATUSES = [{id:'todo',label:'To Do'},{id:'inprogress',label:'In Progress'},{id:'review',label:'Review'},{id:'done',label:'Done'}];
const TASK_STATUS_COLORS = {todo:'#94a3b8',inprogress:'#6366f1',review:'#f59e0b',done:'#22c55e'};
const TASK_CATEGORIES = ['Medical Records','Demand Letter','Filing','Discovery','Deposition','Client Communication','Insurance Follow-up','Court Deadline','Settlement','General'];
const ADMIN_TASK_CATEGORIES = ['Office Management','Billing & Invoicing','HR & Staffing','IT & Systems','Compliance','Marketing','Vendor Management','Training','Reporting','General Admin'];
const PRIORITIES = [{id:'urgent',label:'Urgent'},{id:'high',label:'High'},{id:'medium',label:'Medium'},{id:'low',label:'Low'}];
const ATTORNEY_ROLES = ['Partner','Associate','Of Counsel'];
const STAFF_ROLES = ['Paralegal','Legal Assistant','Case Manager'];
const AVATAR_COLORS = ['#4A90D9','#D94A4A','#4AD98B','#D9A64A','#9B4AD9','#4AD9D9','#D94A8B','#6264a7','#e74c3c','#2ecc71'];

// =========================================
// 2. STATE
// =========================================
let state = {
  clients: [],
  attorneys: [],
  staff: [],
  tasks: [],
  currentView: 'dashboard',
  selectedClientId: null,
  selectedAttorneyId: null,
  filters: {clientId:'',attorneyId:'',status:'',priority:'',category:'',search:''},
  calendarMonth: null,
  modal: {type:null,entityId:null},
  sidebarExpanded: {clients:true,attorneys:true,adminTasks:true},
  expandedTasks: new Set(),
  expandedCompleted: new Set()
};

// Track whether initial Firestore load is done
let firestoreReady = false;
let collectionsLoaded = 0;

// =========================================
// FIRESTORE PERSISTENCE LAYER
// =========================================

// Write a single document to Firestore
function fsSet(collection, id, data) {
  const doc = {...data};
  delete doc.id; // Firestore uses doc ID, not a field
  db.collection(collection).doc(id).set(doc).catch(e => console.error('Firestore write error:', e));
}

// Delete a single document from Firestore
function fsDelete(collection, id) {
  db.collection(collection).doc(id).delete().catch(e => console.error('Firestore delete error:', e));
}

// Save UI-only state to localStorage (view, filters, sidebar â€” not data)
function saveUIState() {
  const ui = {
    currentView: state.currentView,
    selectedClientId: state.selectedClientId,
    selectedAttorneyId: state.selectedAttorneyId,
    filters: state.filters,
    calendarMonth: state.calendarMonth,
    sidebarExpanded: state.sidebarExpanded
  };
  localStorage.setItem('pi-task-manager-ui', JSON.stringify(ui));
}

// Load UI-only state from localStorage
function loadUIState() {
  const saved = localStorage.getItem('pi-task-manager-ui');
  if (saved) {
    try {
      const ui = JSON.parse(saved);
      state.currentView = ui.currentView || 'dashboard';
      state.selectedClientId = ui.selectedClientId || null;
      state.selectedAttorneyId = ui.selectedAttorneyId || null;
      state.filters = ui.filters || {clientId:'',attorneyId:'',status:'',priority:'',category:'',search:''};
      state.calendarMonth = ui.calendarMonth || null;
      state.sidebarExpanded = ui.sidebarExpanded || {clients:true,attorneys:true,adminTasks:true};
    } catch(e) {}
  }
}

// Set up real-time listeners for all collections
function setupRealtimeListeners() {
  COLLECTIONS.forEach(col => {
    db.collection(col).onSnapshot(snapshot => {
      state[col] = snapshot.docs.map(doc => {
        const d = {id: doc.id, ...doc.data()};
        if (col === 'tasks' && !d.subtasks) d.subtasks = [];
        return d;
      });
      // Keep clients, attorneys, and staff alphabetically sorted
      if (['clients','attorneys','staff'].includes(col)) {
        state[col].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
      }
      collectionsLoaded++;
      if (collectionsLoaded >= COLLECTIONS.length && !firestoreReady) {
        firestoreReady = true;
        // If Firestore is empty and never been seeded before, seed it
        if (state.clients.length === 0 && state.attorneys.length === 0 && state.tasks.length === 0 && !localStorage.getItem('pi-data-seeded')) {
          seedFirestore();
          return; // seedFirestore will trigger snapshots which will call render
        }
        // Mark as seeded so deleted data won't trigger re-seeding on refresh
        localStorage.setItem('pi-data-seeded', 'true');
        // Migrate: backfill subtasks on tasks that have none
        migrateSubtasks();
      }
      if (firestoreReady) render();
    }, err => {
      console.error('Firestore listener error on', col, err);
    });
  });
}

// One-time migration: add sample subtasks to existing tasks that have none
function migrateSubtasks() {
  const needsMigration = state.tasks.filter(t => !t.subtasks || t.subtasks.length === 0);
  if (needsMigration.length === 0) return;

  // Check localStorage flag to avoid re-running
  if (localStorage.getItem('pi-subtasks-migrated-v2')) return;

  const today = new Date();
  const d = (off) => { const dt = new Date(today); dt.setDate(dt.getDate()+off); return dt.toISOString().split('T')[0]; };

  // Get attorney/staff IDs for cross-assignment
  const attyIds = state.attorneys.map(a => a.id);
  const staffIds = state.staff.map(s => s.id);
  const allIds = [...attyIds, ...staffIds];
  // Pick a different person than the task assignee
  function otherPerson(taskAssignee) {
    const others = allIds.filter(id => id !== taskAssignee);
    return others.length > 0 ? others[Math.floor(Math.random() * others.length)] : taskAssignee;
  }

  // Build subtask templates keyed by task title keywords
  // Some subtasks are intentionally assigned to different people than the parent task
  const subtaskTemplates = [
    { match: 'medical records', subs: (t) => [
      {title:'Call records department',assignedToId:otherPerson(t.assignedToId),dueDate:d(1),completed:true},
      {title:'Submit HIPAA authorization form',assignedToId:t.assignedToId,dueDate:d(2),completed:true},
      {title:'Follow up on records status',assignedToId:otherPerson(t.assignedToId),dueDate:d(3),completed:false}
    ]},
    { match: 'demand letter', subs: (t) => [
      {title:'Gather all medical documentation',assignedToId:otherPerson(t.assignedToId),dueDate:d(3),completed:true},
      {title:'Calculate total damages',assignedToId:t.assignedToId,dueDate:d(5),completed:false},
      {title:'Draft demand letter',assignedToId:t.assignedToId,dueDate:d(10),completed:false},
      {title:'Review with supervising attorney',assignedToId:otherPerson(t.assignedToId),dueDate:d(12),completed:false}
    ]},
    { match: 'interrogatory', subs: (t) => [
      {title:'Draft initial responses',assignedToId:t.assignedToId,dueDate:d(4),completed:true},
      {title:'Review with client for accuracy',assignedToId:otherPerson(t.assignedToId),dueDate:d(5),completed:false},
      {title:'Finalize and serve',assignedToId:otherPerson(t.assignedToId),dueDate:d(7),completed:false}
    ]},
    { match: 'motion', subs: (t) => [
      {title:'Research case law precedents',assignedToId:t.assignedToId,dueDate:d(1),completed:true},
      {title:'Draft motion brief',assignedToId:t.assignedToId,dueDate:d(2),completed:true},
      {title:'Compile exhibits and declarations',assignedToId:otherPerson(t.assignedToId),dueDate:d(3),completed:false},
      {title:'File with court clerk',assignedToId:otherPerson(t.assignedToId),dueDate:d(4),completed:false}
    ]},
    { match: 'deposition', subs: (t) => [
      {title:'Prepare question outline',assignedToId:t.assignedToId,dueDate:d(3),completed:false},
      {title:'Review relevant documents',assignedToId:otherPerson(t.assignedToId),dueDate:d(5),completed:false},
      {title:'Schedule conference room',assignedToId:otherPerson(t.assignedToId),dueDate:d(2),completed:true}
    ]},
    { match: 'mediation', subs: (t) => [
      {title:'Contact mediator office',assignedToId:t.assignedToId,dueDate:d(2),completed:true},
      {title:'Prepare mediation brief',assignedToId:t.assignedToId,dueDate:d(4),completed:false},
      {title:'Compile settlement documentation',assignedToId:otherPerson(t.assignedToId),dueDate:d(5),completed:false}
    ]},
    { match: 'settlement', subs: (t) => [
      {title:'Calculate settlement value range',assignedToId:t.assignedToId,dueDate:d(3),completed:false},
      {title:'Prepare settlement demand package',assignedToId:otherPerson(t.assignedToId),dueDate:d(6),completed:false}
    ]},
    { match: 'expert witness', subs: (t) => [
      {title:'Identify potential expert witnesses',assignedToId:t.assignedToId,dueDate:d(2),completed:true},
      {title:'Contact and confirm availability',assignedToId:otherPerson(t.assignedToId),dueDate:d(4),completed:false},
      {title:'Draft expert disclosure',assignedToId:t.assignedToId,dueDate:d(7),completed:false}
    ]},
    { match: 'surveillance', subs: (t) => [
      {title:'Submit formal records request',assignedToId:otherPerson(t.assignedToId),dueDate:d(1),completed:true},
      {title:'Follow up with store manager',assignedToId:t.assignedToId,dueDate:d(3),completed:false},
      {title:'Review and catalog footage',assignedToId:otherPerson(t.assignedToId),dueDate:d(5),completed:false}
    ]},
    { match: 'intake', subs: (t) => [
      {title:'Collect personal information',assignedToId:t.assignedToId,dueDate:d(0),completed:true},
      {title:'Obtain signed retainer agreement',assignedToId:otherPerson(t.assignedToId),dueDate:d(0),completed:false},
      {title:'Request initial medical records',assignedToId:otherPerson(t.assignedToId),dueDate:d(1),completed:false}
    ]},
    { match: 'court appearance', subs: (t) => [
      {title:'Prepare appearance documents',assignedToId:t.assignedToId,dueDate:d(1),completed:false},
      {title:'Confirm hearing date and courtroom',assignedToId:otherPerson(t.assignedToId),dueDate:d(1),completed:true},
      {title:'File notice of appearance',assignedToId:otherPerson(t.assignedToId),dueDate:d(2),completed:false}
    ]},
    { match: 'police report', subs: (t) => [
      {title:'Identify police department jurisdiction',assignedToId:t.assignedToId,dueDate:d(2),completed:true},
      {title:'Submit records request form',assignedToId:otherPerson(t.assignedToId),dueDate:d(5),completed:false}
    ]}
  ];

  let migrated = 0;
  needsMigration.forEach(t => {
    const titleLower = t.title.toLowerCase();
    for (const tmpl of subtaskTemplates) {
      if (titleLower.includes(tmpl.match)) {
        const generatedSubs = tmpl.subs(t);
        t.subtasks = generatedSubs.map((s, i) => ({
          id: 'st_m_' + t.id + '_' + i,
          title: s.title,
          link: '',
          assignedToId: s.assignedToId,
          dueDate: s.dueDate,
          completed: s.completed
        }));
        fsSet('tasks', t.id, t);
        migrated++;
        break;
      }
    }
  });

  if (migrated > 0) {
    console.log('Migrated subtasks for', migrated, 'tasks');
    localStorage.setItem('pi-subtasks-migrated-v2', '1');
  }
}

// Seed Firestore with demo data (only runs once if DB is empty)
function seedFirestore() {
  const today = new Date();
  const d = (off) => { const dt = new Date(today); dt.setDate(dt.getDate()+off); return dt.toISOString().split('T')[0]; };

  const attorneys = [
    {id:'a_1',name:'Sarah Chen',initials:'SC',color:'#4A90D9',email:'schen@firm.com',role:'Partner'},
    {id:'a_2',name:'Michael Torres',initials:'MT',color:'#D94A4A',email:'mtorres@firm.com',role:'Associate'},
    {id:'a_3',name:'David Kim',initials:'DK',color:'#9B4AD9',email:'dkim@firm.com',role:'Of Counsel'}
  ];
  const staffMembers = [
    {id:'s_1',name:'Maria Garcia',initials:'MG',color:'#4AD98B',email:'mgarcia@firm.com',role:'Paralegal'},
    {id:'s_2',name:'James Wilson',initials:'JW',color:'#D9A64A',email:'jwilson@firm.com',role:'Legal Assistant'}
  ];
  const clients = [
    {id:'c_1',name:'Robert Johnson',caseNumber:'PI-2025-001',caseType:'Auto Accident',status:'Active',dateOfLoss:d(-120),statuteOfLimitations:d(45),assignedAttorneyId:'a_1',assignedParalegalId:'s_1',notes:'Rear-end collision on Highway 101. Client has soft tissue injuries.',createdAt:Date.now()-86400000*30},
    {id:'c_2',name:'Lisa Martinez',caseNumber:'PI-2025-002',caseType:'Slip & Fall',status:'Discovery',dateOfLoss:d(-200),statuteOfLimitations:d(165),assignedAttorneyId:'a_2',assignedParalegalId:'s_1',notes:'Fell at grocery store due to wet floor. Fractured wrist.',createdAt:Date.now()-86400000*25},
    {id:'c_3',name:'James Thompson',caseNumber:'PI-2025-003',caseType:'Medical Malpractice',status:'Litigation',dateOfLoss:d(-365),statuteOfLimitations:d(25),assignedAttorneyId:'a_1',assignedParalegalId:'s_2',notes:'Surgical error during knee replacement. Extended recovery required.',createdAt:Date.now()-86400000*60},
    {id:'c_4',name:'Karen Williams',caseNumber:'PI-2025-004',caseType:'Workers Comp',status:'Negotiation',dateOfLoss:d(-90),statuteOfLimitations:d(275),assignedAttorneyId:'a_3',assignedParalegalId:'s_2',notes:'Construction site accident. Back injury.',createdAt:Date.now()-86400000*15},
    {id:'c_5',name:'Daniel Brown',caseNumber:'PI-2025-005',caseType:'Product Liability',status:'Intake',dateOfLoss:d(-14),statuteOfLimitations:d(716),assignedAttorneyId:'a_2',assignedParalegalId:'s_1',notes:'Defective power tool caused hand injury.',createdAt:Date.now()-86400000*5},
    {id:'c_6',name:'Patricia Davis',caseNumber:'PI-2024-042',caseType:'Auto Accident',status:'Settled',dateOfLoss:d(-400),statuteOfLimitations:d(-35),assignedAttorneyId:'a_1',assignedParalegalId:'s_1',notes:'Settlement reached for $125,000.',createdAt:Date.now()-86400000*90}
  ];
  const taskData = [
    {title:'Request medical records from St. Mary Hospital',clientId:'c_1',assignedToId:'s_1',priority:'high',status:'inprogress',category:'Medical Records',dueDate:d(3)},
    {title:'Draft demand letter',clientId:'c_1',assignedToId:'a_1',priority:'high',status:'todo',category:'Demand Letter',dueDate:d(14)},
    {title:'Follow up with State Farm adjuster',clientId:'c_1',assignedToId:'s_1',priority:'medium',status:'todo',category:'Insurance Follow-up',dueDate:d(2)},
    {title:'Prepare interrogatory responses',clientId:'c_2',assignedToId:'a_2',priority:'high',status:'inprogress',category:'Discovery',dueDate:d(7)},
    {title:'Schedule client deposition prep',clientId:'c_2',assignedToId:'s_1',priority:'medium',status:'todo',category:'Deposition',dueDate:d(10)},
    {title:'Obtain surveillance footage from store',clientId:'c_2',assignedToId:'s_2',priority:'medium',status:'review',category:'Discovery',dueDate:d(5)},
    {title:'File motion for summary judgment',clientId:'c_3',assignedToId:'a_1',priority:'urgent',status:'inprogress',category:'Filing',dueDate:d(4)},
    {title:'Prepare expert witness list',clientId:'c_3',assignedToId:'a_1',priority:'high',status:'todo',category:'Litigation',dueDate:d(8)},
    {title:'Review opposing counsel deposition transcripts',clientId:'c_3',assignedToId:'a_2',priority:'medium',status:'todo',category:'Deposition',dueDate:d(12)},
    {title:'Schedule mediation session',clientId:'c_4',assignedToId:'a_3',priority:'high',status:'inprogress',category:'Settlement',dueDate:d(6)},
    {title:'Compile medical expense summary',clientId:'c_4',assignedToId:'s_2',priority:'medium',status:'review',category:'Medical Records',dueDate:d(4)},
    {title:'Send settlement counter-offer',clientId:'c_4',assignedToId:'a_3',priority:'high',status:'todo',category:'Settlement',dueDate:d(9)},
    {title:'Complete client intake interview',clientId:'c_5',assignedToId:'a_2',priority:'medium',status:'inprogress',category:'Client Communication',dueDate:d(1)},
    {title:'Obtain police report',clientId:'c_5',assignedToId:'s_1',priority:'low',status:'todo',category:'Filing',dueDate:d(15)},
    {title:'Research product recall history',clientId:'c_5',assignedToId:'s_2',priority:'low',status:'todo',category:'Discovery',dueDate:d(20)},
    {title:'File court appearance notice',clientId:'c_3',assignedToId:'a_1',priority:'urgent',status:'todo',category:'Court Deadline',dueDate:d(2)},
    {title:'Call client with case update',clientId:'c_1',assignedToId:'a_1',priority:'low',status:'done',category:'Client Communication',dueDate:d(-2),completedAt:Date.now()-86400000},
    {title:'Send records request to Dr. Patel',clientId:'c_2',assignedToId:'s_1',priority:'medium',status:'done',category:'Medical Records',dueDate:d(-5),completedAt:Date.now()-86400000*3},
    {title:'File discovery response',clientId:'c_4',assignedToId:'a_3',priority:'high',status:'done',category:'Filing',dueDate:d(-1),completedAt:Date.now()-86400000*0.5},
    {title:'Prepare closing documents',clientId:'c_6',assignedToId:'a_1',priority:'medium',status:'done',category:'Settlement',dueDate:d(-30),completedAt:Date.now()-86400000*28}
  ];
  // Sample subtasks for select tasks
  const sampleSubtasks = {
    0: [ // Request medical records from St. Mary Hospital
      {id:'st_1',title:'Call records department',link:'',assignedToId:'s_1',dueDate:d(1),completed:true},
      {id:'st_2',title:'Submit HIPAA authorization form',link:'',assignedToId:'s_1',dueDate:d(2),completed:true},
      {id:'st_3',title:'Follow up on records status',link:'',assignedToId:'s_1',dueDate:d(3),completed:false}
    ],
    3: [ // Prepare interrogatory responses
      {id:'st_4',title:'Draft initial responses',link:'',assignedToId:'a_2',dueDate:d(4),completed:true},
      {id:'st_5',title:'Review with client',link:'',assignedToId:'a_2',dueDate:d(5),completed:false},
      {id:'st_6',title:'Finalize and serve',link:'',assignedToId:'s_1',dueDate:d(7),completed:false}
    ],
    6: [ // File motion for summary judgment
      {id:'st_7',title:'Research case law precedents',link:'',assignedToId:'a_1',dueDate:d(1),completed:true},
      {id:'st_8',title:'Draft motion brief',link:'',assignedToId:'a_1',dueDate:d(2),completed:true},
      {id:'st_9',title:'Compile exhibits',link:'',assignedToId:'s_2',dueDate:d(3),completed:false},
      {id:'st_10',title:'File with court clerk',link:'',assignedToId:'s_1',dueDate:d(4),completed:false}
    ],
    9: [ // Schedule mediation session
      {id:'st_11',title:'Contact mediator office',link:'',assignedToId:'a_3',dueDate:d(2),completed:true},
      {id:'st_12',title:'Prepare mediation brief',link:'',assignedToId:'a_3',dueDate:d(4),completed:false}
    ]
  };

  const tasks = taskData.map((t,i) => ({
    id: 't_'+(i+1), title: t.title, description: '', dueDate: t.dueDate || '',
    priority: t.priority, status: t.status, category: t.category,
    assignedToId: t.assignedToId, clientId: t.clientId,
    createdAt: Date.now() - 86400000*(20-i), completedAt: t.completedAt || null,
    subtasks: sampleSubtasks[i] || []
  }));

  // Batch write all seed data to Firestore
  const batch = db.batch();
  attorneys.forEach(a => { const {id,...rest}=a; batch.set(db.collection('attorneys').doc(id), rest); });
  staffMembers.forEach(s => { const {id,...rest}=s; batch.set(db.collection('staff').doc(id), rest); });
  clients.forEach(c => { const {id,...rest}=c; batch.set(db.collection('clients').doc(id), rest); });
  tasks.forEach(t => { const {id,...rest}=t; batch.set(db.collection('tasks').doc(id), rest); });
  batch.commit().then(() => {
    localStorage.setItem('pi-data-seeded', 'true');
    console.log('Seed data written to Firestore');
    showToast('Demo data loaded');
  }).catch(e => console.error('Seed error:', e));
}

// =========================================
// 3. DATA HELPERS
// =========================================
function uid(prefix) { return prefix+'_'+Date.now().toString(36)+Math.random().toString(36).slice(2,7); }
function getClient(id) { return id ? state.clients.find(c=>c.id===id) : null; }
function getAttorney(id) { return id ? state.attorneys.find(a=>a.id===id) : null; }
function getStaffMember(id) { return id ? state.staff.find(s=>s.id===id) : null; }
function getAssignee(id) {
  if (!id) return null;
  if (id.startsWith('a_')) return getAttorney(id);
  if (id.startsWith('s_')) return getStaffMember(id);
  return null;
}

function getClientTasks(clientId) { return state.tasks.filter(t=>t.clientId===clientId); }
function getAttorneyTasks(assigneeId) {
  return state.tasks.filter(t =>
    t.assignedToId === assigneeId ||
    (t.subtasks && t.subtasks.some(st => st.assignedToId === assigneeId))
  );
}

function filterTasks(tasks) {
  const f = state.filters;
  return tasks.filter(t => {
    if (f.clientId && t.clientId !== f.clientId) return false;
    if (f.attorneyId && t.assignedToId !== f.attorneyId &&
        !(t.subtasks && t.subtasks.some(st => st.assignedToId === f.attorneyId))) return false;
    if (f.status && t.status !== f.status) return false;
    if (f.priority && t.priority !== f.priority) return false;
    if (f.category && t.category !== f.category) return false;
    if (f.search) {
      const q = f.search.toLowerCase();
      const cl = getClient(t.clientId);
      const as = getAssignee(t.assignedToId);
      const s = [t.title,t.description||'',cl?cl.name:'',cl?cl.caseNumber:'',as?as.name:''].join(' ').toLowerCase();
      if (!s.includes(q)) return false;
    }
    return true;
  });
}

function getOverdueTasks() {
  const today = todayStr();
  return state.tasks.filter(t => t.dueDate && t.dueDate < today && t.status !== 'done');
}

function getUpcomingDeadlines(days) {
  const today = todayStr();
  const end = dateOffset(days);
  return state.tasks.filter(t => t.dueDate && t.dueDate >= today && t.dueDate <= end && t.status !== 'done')
    .sort((a,b) => a.dueDate.localeCompare(b.dueDate));
}

function getSOLWarnings(withinDays) {
  const today = todayStr();
  return state.clients.filter(c => {
    if (!c.statuteOfLimitations) return false;
    if (c.status === 'Settled' || c.status === 'Closed') return false;
    const d = daysUntilDate(c.statuteOfLimitations);
    return d >= 0 && d <= withinDays;
  }).map(c => ({...c, daysLeft: daysUntilDate(c.statuteOfLimitations)}))
    .sort((a,b) => a.daysLeft - b.daysLeft);
}

function getTasksForDate(dateStr) {
  return state.tasks.filter(t => t.dueDate === dateStr && t.status !== 'done');
}

// =========================================
// 4. UTILITIES
// =========================================
function escapeHtml(t) { const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }
function sanitizeUrl(url) {
  if (!url) return '';
  const trimmed = url.trim();
  if (/^(https?:\/\/|mailto:)/i.test(trimmed)) return trimmed;
  if (!/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(trimmed)) return 'https://' + trimmed;
  return '';
}
function todayStr() { return new Date().toISOString().split('T')[0]; }
function dateOffset(days) { const d=new Date(); d.setDate(d.getDate()+days); return d.toISOString().split('T')[0]; }
function daysUntilDate(dateStr) {
  const t = new Date(); t.setHours(0,0,0,0);
  const d = new Date(dateStr+'T00:00:00');
  return Math.ceil((d-t)/(86400000));
}
function formatDate(dateStr) {
  if (!dateStr) return 'â€”';
  const d = new Date(dateStr+'T00:00:00');
  return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
}
function formatDateShort(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr+'T00:00:00');
  return d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
}
function isOverdue(dateStr) { return dateStr && dateStr < todayStr(); }
function isSoon(dateStr) { if (!dateStr) return false; const d=daysUntilDate(dateStr); return d>=0 && d<=3; }

function dueDateClass(dateStr) {
  if (!dateStr) return '';
  if (isOverdue(dateStr)) return 'overdue';
  if (isSoon(dateStr)) return 'soon';
  return '';
}

function dueDateLabel(dateStr) {
  if (!dateStr) return '';
  const days = daysUntilDate(dateStr);
  if (days < 0) return `${Math.abs(days)}d overdue`;
  if (days === 0) return 'Today';
  if (days === 1) return 'Tomorrow';
  if (days <= 7) return `${days}d`;
  return formatDateShort(dateStr);
}

function statusLabel(s) { const m=TASK_STATUSES.find(x=>x.id===s); return m?m.label:s; }
function priorityOrder(p) { return {urgent:0,high:1,medium:2,low:3}[p]??4; }

function debounce(fn, ms) {
  let t; return function(...args) { clearTimeout(t); t=setTimeout(()=>fn.apply(this,args),ms); };
}

// =========================================
// 5. CRUD (Firestore-backed)
// =========================================
function addClient(data) {
  const id = uid('c');
  const c = {id, createdAt: Date.now(), ...data};
  state.clients.push(c);
  state.clients.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
  fsSet('clients', id, c);
  render(); showToast('Client added');
  return c;
}
function updateClient(id, data) {
  const c = getClient(id); if (!c) return;
  Object.assign(c, data);
  state.clients.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
  fsSet('clients', id, c);
  render(); showToast('Client updated');
}
function deleteClient(id) {
  state.clients = state.clients.filter(c => c.id !== id);
  // Also delete all tasks for this client
  const tasksToDelete = state.tasks.filter(t => t.clientId === id);
  state.tasks = state.tasks.filter(t => t.clientId !== id);
  fsDelete('clients', id);
  tasksToDelete.forEach(t => fsDelete('tasks', t.id));
  if (state.selectedClientId === id) { state.selectedClientId = null; state.currentView = 'dashboard'; }
  saveUIState(); render(); showToast('Client deleted');
}

function addAttorney(data) {
  const id = uid('a');
  const a = {id, ...data};
  state.attorneys.push(a);
  state.attorneys.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
  fsSet('attorneys', id, a);
  render(); showToast('Team member added');
}
function updateAttorney(id, data) {
  const a = getAttorney(id); if (!a) return;
  Object.assign(a, data);
  fsSet('attorneys', id, a);
  render();
}
function deleteAttorney(id) {
  state.attorneys = state.attorneys.filter(a => a.id !== id);
  state.tasks.forEach(t => {
    let changed = false;
    if (t.assignedToId === id) { t.assignedToId = ''; changed = true; }
    if (t.subtasks) t.subtasks.forEach(st => { if (st.assignedToId === id) { st.assignedToId = ''; changed = true; } });
    if (changed) fsSet('tasks', t.id, t);
  });
  state.clients.forEach(c => { if (c.assignedAttorneyId === id) { c.assignedAttorneyId = ''; fsSet('clients', c.id, c); } });
  fsDelete('attorneys', id);
  if (state.selectedAttorneyId === id) { state.selectedAttorneyId = null; state.currentView = 'dashboard'; }
  saveUIState(); render(); showToast('Team member removed');
}

function addStaffMember(data) {
  const id = uid('s');
  const s = {id, ...data};
  state.staff.push(s);
  state.staff.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
  fsSet('staff', id, s);
  render(); showToast('Staff member added');
}
function deleteStaffMember(id) {
  state.staff = state.staff.filter(s => s.id !== id);
  state.tasks.forEach(t => {
    let changed = false;
    if (t.assignedToId === id) { t.assignedToId = ''; changed = true; }
    if (t.subtasks) t.subtasks.forEach(st => { if (st.assignedToId === id) { st.assignedToId = ''; changed = true; } });
    if (changed) fsSet('tasks', t.id, t);
  });
  state.clients.forEach(c => { if (c.assignedParalegalId === id) { c.assignedParalegalId = ''; fsSet('clients', c.id, c); } });
  fsDelete('staff', id);
  render(); showToast('Staff member removed');
}

function addTask(data) {
  const id = uid('t');
  const t = {id, description: '', completedAt: null, createdAt: Date.now(), subtasks: [], ...data};
  state.tasks.push(t);
  fsSet('tasks', id, t);
  render(); showToast('Task added');
  return t;
}
function updateTask(id, data) {
  const t = state.tasks.find(x => x.id === id); if (!t) return;
  Object.assign(t, data);
  if (data.status === 'done' && !t.completedAt) t.completedAt = Date.now();
  if (data.status && data.status !== 'done') t.completedAt = null;
  fsSet('tasks', id, t);
  render(); showToast('Task updated');
}
function deleteTask(id) {
  state.tasks = state.tasks.filter(t => t.id !== id);
  fsDelete('tasks', id);
  render(); showToast('Task deleted');
}
function toggleTaskDone(id) {
  const t = state.tasks.find(x => x.id === id); if (!t) return;
  t.status = t.status === 'done' ? 'todo' : 'done';
  t.completedAt = t.status === 'done' ? Date.now() : null;
  fsSet('tasks', id, t);
  render(); showToast(t.status === 'done' ? 'Task completed' : 'Task reopened');
}


// =========================================
// 6. NAVIGATION
// =========================================
function navigate(view, params={}) {
  state.currentView = view;
  state.selectedClientId = params.clientId || null;
  state.selectedAttorneyId = params.attorneyId || null;
  if (!params.preserveFilters) {
    state.filters = {clientId:'',attorneyId:'',status:'',priority:'',category:'',search:''};
  }
  if (view==='byClient' && params.clientId) state.filters.clientId = params.clientId;
  if (view==='byAttorney' && params.attorneyId) state.filters.attorneyId = params.attorneyId;
  // Close mobile sidebar on navigation
  const sidebar = document.querySelector('.sidebar');
  if (sidebar) sidebar.classList.remove('open');
  const overlay = document.getElementById('sidebarOverlay');
  if (overlay) overlay.classList.remove('show');
  saveUIState();
  render();
}

// =========================================
// 7. RENDER
// =========================================
function render() {
  renderSidebar();
  renderHeader();
  renderFilterBar();
  renderContent();
}

// -- SIDEBAR --
function renderSidebar() {
  const nav = document.getElementById('sidebarNav');
  const footer = document.getElementById('sidebarFooter');
  let h = '';

  // Main nav
  h += navItem('dashboard','ðŸ“Š','Dashboard',null);
  h += navItem('board','ðŸ“‹','All Tasks',state.tasks.filter(t=>t.status!=='done' && !t.isAdmin).length);

  // Clients section
  const cExp = state.sidebarExpanded.clients;
  h += `<div class="nav-section" onclick="toggleSection('clients')">CLIENTS <span class="toggle-arrow ${cExp?'':'collapsed'}">â–¼</span></div>`;
  h += `<div class="nav-children ${cExp?'':'collapsed'}">`;
  state.clients.forEach(c => {
    const cnt = getClientTasks(c.id).filter(t=>t.status!=='done').length;
    const active = state.currentView==='byClient' && state.selectedClientId===c.id;
    h += `<div class="nav-item ${active?'active':''}" onclick="navigate('byClient',{clientId:'${c.id}'})">
      <span class="nav-label">${escapeHtml(c.name)}</span>
      <span style="display:flex;align-items:center;gap:4px">
        <span class="badge">${cnt}</span>
        <button class="delete-btn" onclick="event.stopPropagation();if(confirm('Delete this client and all their tasks?'))deleteClient('${c.id}')" title="Delete client">âœ•</button>
      </span>
    </div>`;
  });
  h += '</div>';

  // Team Members section
  const aExp = state.sidebarExpanded.attorneys;
  h += `<div class="nav-section" onclick="toggleSection('attorneys')">TEAM MEMBERS <span class="toggle-arrow ${aExp?'':'collapsed'}">â–¼</span></div>`;
  h += `<div class="nav-children ${aExp?'':'collapsed'}">`;
  state.attorneys.forEach(a => {
    const cnt = getAttorneyTasks(a.id).filter(t=>t.status!=='done').length;
    const active = state.currentView==='byAttorney' && state.selectedAttorneyId===a.id;
    h += `<div class="nav-item ${active?'active':''}" onclick="navigate('byAttorney',{attorneyId:'${a.id}'})">
      <span class="nav-label">${escapeHtml(a.name)}</span>
      <span style="display:flex;align-items:center;gap:4px">
        <span class="badge">${cnt}</span>
        <button class="delete-btn" onclick="event.stopPropagation();if(confirm('Remove this team member? Their task assignments will be cleared.'))deleteAttorney('${a.id}')" title="Delete team member">âœ•</button>
      </span>
    </div>`;
  });
  state.staff.forEach(s => {
    const cnt = getAttorneyTasks(s.id).filter(t=>t.status!=='done').length;
    const active = state.currentView==='byAttorney' && state.selectedAttorneyId===s.id;
    h += `<div class="nav-item ${active?'active':''}" onclick="navigate('byAttorney',{attorneyId:'${s.id}'})">
      <span class="nav-label">${escapeHtml(s.name)}</span>
      <span style="display:flex;align-items:center;gap:4px">
        <span class="badge">${cnt}</span>
        <button class="delete-btn" onclick="event.stopPropagation();if(confirm('Remove this staff member? Their task assignments will be cleared.'))deleteStaffMember('${s.id}')" title="Delete staff member">âœ•</button>
      </span>
    </div>`;
  });
  h += '</div>';

  // Admin Tasks section
  const adExp = state.sidebarExpanded.adminTasks;
  h += `<div class="nav-section" onclick="toggleSection('adminTasks')">ADMIN TASKS <span class="toggle-arrow ${adExp?'':'collapsed'}">â–¼</span></div>`;
  h += `<div class="nav-children ${adExp?'':'collapsed'}">`;
  const adminActiveCount = state.tasks.filter(t => t.isAdmin && t.status !== 'done').length;
  const adminActive = state.currentView === 'adminBoard';
  h += `<div class="nav-item ${adminActive?'active':''}" onclick="navigate('adminBoard')">
    <span class="nav-label">All Admin Tasks</span>
    <span class="badge">${adminActiveCount}</span>
  </div>`;
  h += '</div>';

  nav.innerHTML = h;

  // Footer
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  footer.innerHTML = `
    <div class="nav-item" onclick="toggleDarkMode()"><span class="nav-icon">${isDark ? '\u2600' : '\u263E'}</span><span class="nav-label">${isDark ? 'Light Mode' : 'Dark Mode'}</span></div>
    <div class="nav-item" onclick="openModal('addClient')"><span class="nav-icon">+</span><span class="nav-label">Add Client</span></div>
    <div class="nav-item" onclick="openModal('addAttorney')"><span class="nav-icon">+</span><span class="nav-label">Add Team Member</span></div>
    <div class="nav-item" onclick="openModal('addAdminTask')"><span class="nav-icon">+</span><span class="nav-label">Add Admin Task</span></div>
  `;
}

function navItem(view, icon, label, count) {
  const active = state.currentView === view ? 'active' : '';
  const badge = count !== null ? `<span class="badge">${count}</span>` : '';
  return `<div class="nav-item ${active}" onclick="navigate('${view}')"><span class="nav-icon">${icon}</span><span class="nav-label">${label}</span>${badge}</div>`;
}

function toggleSection(section) {
  state.sidebarExpanded[section] = !state.sidebarExpanded[section];
  saveUIState();
  renderSidebar();
}

// -- HEADER --
function renderHeader() {
  const el = document.getElementById('mainHeader');
  const titles = {
    dashboard: 'Dashboard',
    board: 'All Tasks',
    calendar: 'Calendar',
    byClient: state.selectedClientId ? (getClient(state.selectedClientId)?.name || 'Client') : 'Client',
    byAttorney: state.selectedAttorneyId ? (getAssignee(state.selectedAttorneyId)?.name || 'Team Member') : 'Team Member',
    adminBoard: 'Admin Tasks'
  };
  const title = titles[state.currentView] || 'Tasks';

  const showViewToggles = ['board','calendar'].includes(state.currentView);
  const viewToggleHtml = showViewToggles ? `
    <div class="view-toggles">
      <button class="view-toggle-btn ${state.currentView==='board'?'active':''}" onclick="navigate('board',{preserveFilters:true})">Board</button>
      <button class="view-toggle-btn ${state.currentView==='calendar'?'active':''}" onclick="navigate('calendar',{preserveFilters:true})">Calendar</button>
    </div>
  ` : '';

  const showAddBtn = state.currentView !== 'dashboard';
  let addBtnHtml = '';
  if (state.currentView === 'adminBoard') {
    addBtnHtml = `<button class="header-add-btn" onclick="openModal('addAdminTask')">+ Add Admin Task</button>`;
  } else if (showAddBtn) {
    addBtnHtml = `<button class="header-add-btn" onclick="openModal('addTask')">+ Add Task</button>`;
  }

  el.innerHTML = `
    <div class="view-title">${escapeHtml(title)}</div>
    <div class="header-spacer"></div>
    <div class="search-box">
      <span class="search-icon">ðŸ”</span>
      <input type="text" placeholder="Search tasks, clients..." value="${escapeHtml(state.filters.search||'')}" oninput="handleSearch(this.value)">
    </div>
    ${viewToggleHtml}
    ${addBtnHtml}
  `;
}

// -- FILTER BAR --
function renderFilterBar() {
  const el = document.getElementById('filterBar');
  const showFilter = ['board','byClient','byAttorney','adminBoard'].includes(state.currentView);
  if (!showFilter) { el.innerHTML=''; el.className=''; return; }
  el.className = 'filter-bar';

  const f = state.filters;
  const isAdmin = state.currentView === 'adminBoard';
  const clientOpts = state.clients.map(c=>`<option value="${c.id}" ${f.clientId===c.id?'selected':''}>${escapeHtml(c.name)}</option>`).join('');
  const assigneeOpts = [...state.attorneys,...state.staff].map(a=>`<option value="${a.id}" ${f.attorneyId===a.id?'selected':''}>${escapeHtml(a.name)}</option>`).join('');
  const statusOpts = TASK_STATUSES.map(s=>`<option value="${s.id}" ${f.status===s.id?'selected':''}>${s.label}</option>`).join('');
  const prioOpts = PRIORITIES.map(p=>`<option value="${p.id}" ${f.priority===p.id?'selected':''}>${p.label}</option>`).join('');
  const cats = isAdmin ? ADMIN_TASK_CATEGORIES : TASK_CATEGORIES;
  const catOpts = cats.map(c=>`<option value="${c}" ${f.category===c?'selected':''}>${c}</option>`).join('');

  el.innerHTML = `
    <label>Filter:</label>
    ${isAdmin ? '' : `<select onchange="setFilter('clientId',this.value)"><option value="">All Clients</option>${clientOpts}</select>`}
    <select onchange="setFilter('attorneyId',this.value)"><option value="">All Assignees</option>${assigneeOpts}</select>
    <select onchange="setFilter('status',this.value)"><option value="">All Statuses</option>${statusOpts}</select>
    <select onchange="setFilter('priority',this.value)"><option value="">All Priorities</option>${prioOpts}</select>
    <select onchange="setFilter('category',this.value)"><option value="">All Categories</option>${catOpts}</select>
  `;
}

function setFilter(key, val) {
  state.filters[key] = val;
  saveUIState();
  render();
}

const handleSearch = debounce(function(val) {
  state.filters.search = val;
  saveUIState();
  renderContent();
}, 250);

// -- CONTENT --
function renderContent() {
  const el = document.getElementById('mainContent');
  switch(state.currentView) {
    case 'dashboard': renderDashboard(el); break;
    case 'board': renderBoardView(el); break;
    case 'calendar': renderCalendarView(el); break;
    case 'byClient': renderByClientView(el); break;
    case 'byAttorney': renderByAttorneyView(el); break;
    case 'adminBoard': renderAdminBoardView(el); break;
    default: renderDashboard(el);
  }
}

// =========================================
// 8. VIEW RENDERERS
// =========================================

// -- DASHBOARD --
function renderDashboard(el) {
  const activeTasks = state.tasks.filter(t=>t.status!=='done' && !t.isAdmin);
  const activeAdminTasks = state.tasks.filter(t=>t.status!=='done' && t.isAdmin);
  const overdue = getOverdueTasks();
  const upcoming = getUpcomingDeadlines(7);
  const thisMonth = state.tasks.filter(t=>{
    if(t.status!=='done'||!t.completedAt)return false;
    const d=new Date(t.completedAt);const n=new Date();
    return d.getMonth()===n.getMonth()&&d.getFullYear()===n.getFullYear();
  });
  const activeClients = state.clients.filter(c=>c.status!=='Settled'&&c.status!=='Closed');
  const solWarnings = getSOLWarnings(90);
  const deadlines = getUpcomingDeadlines(30).slice(0,10);

  let h = `<div class="stats-row">
    <div class="stat-card accent"><div class="stat-value">${activeTasks.length}</div><div class="stat-label">Active Tasks</div></div>
    <div class="stat-card danger"><div class="stat-value">${overdue.length}</div><div class="stat-label">Overdue</div></div>
    <div class="stat-card warning"><div class="stat-value">${upcoming.length}</div><div class="stat-label">Due This Week</div></div>
    <div class="stat-card success"><div class="stat-value">${thisMonth.length}</div><div class="stat-label">Completed This Month</div></div>
    <div class="stat-card"><div class="stat-value">${activeClients.length}</div><div class="stat-label">Active Clients</div></div>
    <div class="stat-card" style="cursor:pointer" onclick="navigate('adminBoard')"><div class="stat-value">${activeAdminTasks.length}</div><div class="stat-label">Admin Tasks</div></div>
  </div>`;

  h += '<div class="dashboard-grid">';

  // Upcoming deadlines
  h += '<div class="dash-section"><div class="dash-section-header">ðŸ“… Upcoming Deadlines</div><div class="dash-section-body">';
  if (deadlines.length === 0) {
    h += '<div style="padding:20px;text-align:center;color:var(--text-secondary);font-size:13px;">No upcoming deadlines</div>';
  } else {
    deadlines.forEach(t => {
      const cl = getClient(t.clientId);
      const dc = dueDateClass(t.dueDate);
      h += `<div class="deadline-item" onclick="openModal('taskDetail','${t.id}')">
        <div class="dl-info"><div class="dl-title">${escapeHtml(t.title)}</div><div class="dl-client">${cl?escapeHtml(cl.name):''}</div></div>
        <div class="dl-date ${dc}">${dueDateLabel(t.dueDate)}</div>
      </div>`;
    });
  }
  h += '</div></div>';

  // SOL warnings
  h += '<div class="dash-section"><div class="dash-section-header">âš ï¸ Statute of Limitations Alerts</div><div class="dash-section-body">';
  if (solWarnings.length === 0) {
    h += '<div style="padding:20px;text-align:center;color:var(--text-secondary);font-size:13px;">No SOL alerts</div>';
  } else {
    solWarnings.forEach(c => {
      const cls = c.daysLeft<=30?'critical':c.daysLeft<=60?'warning':'caution';
      h += `<div class="sol-item ${cls}" onclick="navigate('byClient',{clientId:'${c.id}'})">
        <div class="sol-info"><div class="sol-name">${escapeHtml(c.name)}</div><div class="sol-case">${escapeHtml(c.caseType)} Â· ${c.caseNumber}</div></div>
        <div class="sol-days" style="color:${c.daysLeft<=30?'var(--priority-high)':c.daysLeft<=60?'var(--priority-medium)':'#f97316'}">${c.daysLeft}d left</div>
      </div>`;
    });
  }
  h += '</div></div>';

  h += '</div>';
  el.innerHTML = h;
}

function taskCardHtml(t) {
  const cl = getClient(t.clientId);
  const as = getAssignee(t.assignedToId);
  const dc = dueDateClass(t.dueDate);
  const isDone = t.status === 'done';
  return `<div class="task-card ${isDone?'done-task':''}" data-id="${t.id}" data-priority="${t.priority}">
    <div class="task-check ${isDone?'checked':''}" onclick="event.stopPropagation();toggleTaskDone('${t.id}')"></div>
    <div class="task-body">
      <div class="task-title">${escapeHtml(t.title)}</div>
      <div class="task-meta">
        ${cl?`<span class="task-client-tag">${escapeHtml(cl.name)}</span>`:''}
        ${t.category?`<span class="task-category-pill">${escapeHtml(t.category)}</span>`:''}
        ${t.dueDate?`<span class="task-due ${dc}">${dueDateLabel(t.dueDate)}</span>`:''}
        <span class="priority-badge ${t.priority}">${t.priority}</span>
        ${(t.subtasks&&t.subtasks.length)?`<span class="board-card-subtasks" style="margin-left:4px"><span class="${t.subtasks.filter(s=>s.completed).length===t.subtasks.length?'st-done':''}">âœ“ ${t.subtasks.filter(s=>s.completed).length}/${t.subtasks.length}</span></span>`:''}
      </div>
    </div>
    ${as?`<div class="avatar" style="background:${as.color}" title="${escapeHtml(as.name)}">${escapeHtml(as.initials)}</div>`:''}
    <div class="task-actions">
      <button class="icon-btn danger" onclick="event.stopPropagation();if(confirm('Delete this task?'))deleteTask('${t.id}')" title="Delete">âœ•</button>
    </div>
  </div>`;
}

function taskCardWithSubtasksHtml(t) {
  let h = taskCardHtml(t);
  const subs = t.subtasks || [];
  h += '<div class="atty-subtask-list">';
  if (subs.length > 0) {
    subs.forEach((st, idx) => {
      const stAs = getAssignee(st.assignedToId);
      h += `<div class="atty-st-row ${st.completed?'completed':''}">
        <div class="atty-st-check ${st.completed?'checked':''}" onclick="event.stopPropagation();toggleBoardSubtask('${t.id}',${idx})">${st.completed?'âœ“':''}</div>
        <span class="atty-st-title">${escapeHtml(st.title)}</span>
        ${st.link ? `<a class="atty-st-link" href="${escapeHtml(sanitizeUrl(st.link))}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" title="${escapeHtml(st.link)}">ðŸ”—</a>` : ''}
        ${stAs ? `<span class="atty-st-assignee">${escapeHtml(stAs.name)}</span>` : ''}
        ${st.dueDate ? `<span class="atty-st-due ${dueDateClass(st.dueDate)}">${dueDateLabel(st.dueDate)}</span>` : ''}
      </div>`;
    });
  }
  h += `<div class="atty-st-row" style="border:none">
    <span class="atty-st-title" style="color:var(--accent);cursor:pointer;text-decoration:none;font-size:11px" onclick="event.stopPropagation();openModal('taskDetail','${t.id}')">+ Add subtask</span>
  </div>`;
  h += '</div>';
  return h;
}

// -- BOARD VIEW --
function boardCardHtml(t) {
  const as = getAssignee(t.assignedToId);
  const statusObj = TASK_STATUSES.find(s => s.id === t.status);
  const isDone = t.status === 'done';
  const subs = t.subtasks || [];
  const subsDone = subs.filter(s => s.completed).length;
  const subsTotal = subs.length;
  const isExpanded = state.expandedTasks.has(t.id);

  let h = `<div class="board-card ${isDone?'done-task':''}" data-priority="${t.priority}" onclick="openModal('taskDetail','${t.id}')">
    <div style="display:flex;align-items:flex-start;gap:8px">
      <div class="board-card-check ${isDone?'checked':''}" onclick="event.stopPropagation();toggleTaskDone('${t.id}')">${isDone?'âœ“':''}</div>
      <div style="flex:1;min-width:0">
        <div class="board-card-title">${escapeHtml(t.title)}</div>
        <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:4px">
          ${t.category ? `<span class="board-card-category">${escapeHtml(t.category)}</span>` : ''}
          ${subsTotal > 0 ? `<span class="board-card-subtasks" onclick="event.stopPropagation();toggleExpandSubtasks('${t.id}')" title="Click to ${isExpanded?'collapse':'expand'} subtasks"><span class="${subsDone===subsTotal && subsTotal>0?'st-done':''}">${isExpanded?'â–¾':'â–¸'} âœ“ ${subsDone}/${subsTotal}</span></span>` : ''}
        </div>
      </div>
    </div>
    <div class="board-card-meta" style="margin-top:6px">
      <div>
        ${statusObj ? `<span style="color:${TASK_STATUS_COLORS[t.status]};font-size:11px;font-weight:600">${statusObj.label}</span>` : ''}
        ${t.dueDate ? `<span class="task-due ${dueDateClass(t.dueDate)}" style="margin-left:6px">${dueDateLabel(t.dueDate)}</span>` : ''}
      </div>
      ${as ? `<div class="avatar" style="background:${as.color};width:22px;height:22px;font-size:9px" title="${escapeHtml(as.name)}">${escapeHtml(as.initials)}</div>` : ''}
    </div>`;

  // Expanded inline subtask list
  if (isExpanded && subsTotal > 0) {
    h += '<div class="board-card-subtask-list" onclick="event.stopPropagation()">';
    subs.forEach((st, idx) => {
      const stAs = getAssignee(st.assignedToId);
      h += `<div class="board-card-st-row ${st.completed?'completed':''}">
        <div class="board-card-st-check ${st.completed?'checked':''}" onclick="toggleBoardSubtask('${t.id}',${idx})">${st.completed?'âœ“':''}</div>
        <span class="board-card-st-title">${escapeHtml(st.title)}</span>
        ${stAs ? `<div class="avatar" style="background:${stAs.color};width:16px;height:16px;font-size:7px;flex-shrink:0" title="${escapeHtml(stAs.name)}">${escapeHtml(stAs.initials)}</div>` : ''}
      </div>`;
    });
    h += '</div>';
  }

  h += '</div>';
  return h;
}

function renderBoardView(el, filterToAssigneeId) {
  let tasks = filterTasks(state.tasks).filter(t => !t.isAdmin);
  if (filterToAssigneeId) tasks = tasks.filter(t =>
    t.assignedToId === filterToAssigneeId ||
    (t.subtasks && t.subtasks.some(st => st.assignedToId === filterToAssigneeId))
  );

  // Group tasks by client
  const byClient = {};
  tasks.forEach(t => {
    const cid = t.clientId || '__none';
    if (!byClient[cid]) byClient[cid] = [];
    byClient[cid].push(t);
  });

  // Also include clients with 0 tasks (only when not filtered to a specific assignee)
  if (!filterToAssigneeId) {
    state.clients.forEach(c => { if (!byClient[c.id]) byClient[c.id] = []; });
  }

  let h = '<div class="board">';
  const clientIds = Object.keys(byClient).sort((a, b) => {
    if (a === '__none') return 1;
    if (b === '__none') return -1;
    const ca = getClient(a), cb = getClient(b);
    return (ca?.name || '').localeCompare(cb?.name || '');
  });

  clientIds.forEach(cid => {
    const client = getClient(cid);
    const allColTasks = byClient[cid].sort((a, b) => priorityOrder(a.priority) - priorityOrder(b.priority) || (a.dueDate || '9').localeCompare(b.dueDate || '9'));
    const activeTasks = allColTasks.filter(t => t.status !== 'done');
    const doneTasks = allColTasks.filter(t => t.status === 'done');
    const clientName = client ? client.name : 'Unassigned Client';
    const caseType = client ? (client.caseType || '') : '';
    const preAssignee = filterToAssigneeId || '';
    const completedOpen = state.expandedCompleted.has(cid);

    h += `<div class="board-column">
      <div class="board-col-header">
        <span>${escapeHtml(clientName)}${caseType ? ' <span style="font-weight:400;font-size:11px;color:var(--text-secondary)">Â· ' + escapeHtml(caseType) + '</span>' : ''}</span>
        <div class="header-right">
          <span class="col-count">${activeTasks.length}</span>
          ${client ? `<button class="delete-btn" onclick="event.stopPropagation();if(confirm('Delete client \\'${escapeHtml(clientName).replace(/'/g,"\\\\'")}\\' and all their tasks?'))deleteClient('${cid}')" title="Delete client">âœ•</button>` : ''}
        </div>
      </div>
      <div class="board-col-body">
        <button class="board-col-add-btn" onclick="openModal('addTask',null,{clientId:'${cid === '__none' ? '' : cid}',assigneeId:'${preAssignee}'})">+ Add Task</button>`;

    // Active tasks
    activeTasks.forEach(t => { h += boardCardHtml(t); });

    // Completed section
    if (doneTasks.length > 0) {
      h += `<div class="board-completed-toggle" onclick="toggleCompletedSection('${cid}')">
        <span>${completedOpen ? 'â–¾' : 'â–¸'}</span> Completed <span style="font-weight:400">(${doneTasks.length})</span>
      </div>`;
      if (completedOpen) {
        doneTasks.forEach(t => { h += boardCardHtml(t); });
      }
    }

    h += '</div></div>';
  });

  if (clientIds.length === 0) {
    h += '<div style="padding:40px;text-align:center;color:var(--text-secondary)">No tasks found</div>';
  }

  h += '</div>';
  el.innerHTML = h;
}

// -- BOARD TOGGLE FUNCTIONS --
function toggleExpandSubtasks(taskId) {
  if (state.expandedTasks.has(taskId)) state.expandedTasks.delete(taskId);
  else state.expandedTasks.add(taskId);
  render();
}

function toggleBoardSubtask(taskId, idx) {
  const t = state.tasks.find(x => x.id === taskId);
  if (!t || !t.subtasks || !t.subtasks[idx]) return;
  t.subtasks[idx].completed = !t.subtasks[idx].completed;
  fsSet('tasks', taskId, t);
  render();
}

function toggleCompletedSection(clientId) {
  if (state.expandedCompleted.has(clientId)) state.expandedCompleted.delete(clientId);
  else state.expandedCompleted.add(clientId);
  render();
}

// -- ADMIN BOARD VIEW --
function renderAdminBoardView(el) {
  let tasks = filterTasks(state.tasks).filter(t => t.isAdmin);

  const statusCols = [
    {id:'todo', label:'To Do', color:'var(--status-todo)'},
    {id:'inprogress', label:'In Progress', color:'var(--status-inprogress)'},
    {id:'review', label:'Review', color:'var(--status-review)'},
    {id:'done', label:'Done', color:'var(--status-done)'}
  ];

  let h = '<div class="board">';

  statusCols.forEach(col => {
    const colTasks = tasks.filter(t => t.status === col.id)
      .sort((a, b) => priorityOrder(a.priority) - priorityOrder(b.priority) || (a.dueDate || '9').localeCompare(b.dueDate || '9'));
    h += `<div class="board-column">
      <div class="board-col-header">
        <span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${col.color};margin-right:6px"></span>${col.label}</span>
        <div class="header-right">
          <span class="col-count">${colTasks.length}</span>
        </div>
      </div>
      <div class="board-col-body">
        <button class="board-col-add-btn" onclick="openModal('addAdminTask',null,{status:'${col.id}'})">+ Add Task</button>`;

    colTasks.forEach(t => { h += boardCardHtml(t); });

    h += '</div></div>';
  });

  if (tasks.length === 0 && state.tasks.filter(t => t.isAdmin).length === 0) {
    h = '<div class="board"><div style="padding:40px;text-align:center;color:var(--text-secondary);width:100%">No admin tasks yet. Click "+ Add Admin Task" to create one.</div></div>';
  } else {
    h += '</div>';
  }
  el.innerHTML = h;
}

// -- CALENDAR VIEW --
function renderCalendarView(el) {
  const now = new Date();
  const year = state.calendarMonth !== null ? state.calendarMonth.year : now.getFullYear();
  const month = state.calendarMonth !== null ? state.calendarMonth.month : now.getMonth();
  const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];

  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();
  const daysInPrev = new Date(year, month, 0).getDate();
  const todayS = todayStr();

  let h = `<div class="calendar-nav">
    <button class="cal-nav-btn" onclick="calNav(-1)">â—€</button>
    <button class="cal-nav-btn" onclick="calNav(1)">â–¶</button>
    <span class="month-label">${monthNames[month]} ${year}</span>
    <button class="today-btn" onclick="state.calendarMonth=null;saveUIState();render()">Today</button>
  </div>`;

  h += '<div class="calendar-grid">';
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => { h += `<div class="cal-day-header">${d}</div>`; });

  // Build cells
  const cells = [];
  for (let i=firstDay-1; i>=0; i--) cells.push({day:daysInPrev-i, m:month-1, other:true});
  for (let d=1; d<=daysInMonth; d++) cells.push({day:d, m:month, other:false});
  while (cells.length < 42) cells.push({day:cells.length-firstDay-daysInMonth+1, m:month+1, other:true});

  cells.forEach(c => {
    const y = c.m<0 ? year-1 : c.m>11 ? year+1 : year;
    const m = ((c.m%12)+12)%12;
    const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(c.day).padStart(2,'0')}`;
    const isToday = ds === todayS;
    const tasks = getTasksForDate(ds);

    h += `<div class="cal-day ${c.other?'other-month':''} ${isToday?'today':''}" onclick="openModal('addTask',null,'${ds}')">`;
    h += `<div class="day-num">${c.day}</div>`;
    const show = tasks.slice(0,3);
    show.forEach(t => {
      h += `<div class="cal-task-pill ${t.priority}" onclick="event.stopPropagation();openModal('taskDetail','${t.id}')">${escapeHtml(t.title)}</div>`;
    });
    if (tasks.length > 3) h += `<div class="cal-more">+${tasks.length-3} more</div>`;
    h += '</div>';
  });

  h += '</div>';
  el.innerHTML = h;
}

function calNav(dir) {
  const now = new Date();
  let year = state.calendarMonth !== null ? state.calendarMonth.year : now.getFullYear();
  let month = state.calendarMonth !== null ? state.calendarMonth.month : now.getMonth();
  month += dir;
  if (month < 0) { month = 11; year--; }
  if (month > 11) { month = 0; year++; }
  state.calendarMonth = {year, month};
  saveUIState();
  render();
}

// -- BY CLIENT VIEW --
function renderByClientView(el) {
  const client = getClient(state.selectedClientId);
  if (!client) { el.innerHTML = emptyState('Client not found','Select a client from the sidebar'); return; }

  const atty = getAttorney(client.assignedAttorneyId);
  const para = getAssignee(client.assignedParalegalId);
  const solDays = client.statuteOfLimitations ? daysUntilDate(client.statuteOfLimitations) : null;

  let h = `<div class="client-summary">
    <div class="client-summary-header">
      <h2>${escapeHtml(client.name)}</h2>
      <div>
        <button class="btn btn-secondary btn-sm" onclick="openModal('editClient','${client.id}')">Edit</button>
        <button class="btn btn-danger btn-sm" onclick="if(confirm('Delete this client and all their tasks?'))deleteClient('${client.id}')">Delete</button>
      </div>
    </div>
    <div class="client-summary-grid">
      <div class="cs-field"><div class="cs-label">Case Number</div><div class="cs-value">${escapeHtml(client.caseNumber)}</div></div>
      <div class="cs-field"><div class="cs-label">Case Type</div><div class="cs-value">${escapeHtml(client.caseType)}</div></div>
      <div class="cs-field"><div class="cs-label">Status</div><div class="cs-value"><span class="client-status-badge" style="background:${CLIENT_STATUS_COLORS[client.status]||'#6b7280'}20;color:${CLIENT_STATUS_COLORS[client.status]||'#6b7280'}">${client.status}</span></div></div>
      <div class="cs-field"><div class="cs-label">Date of Loss</div><div class="cs-value">${formatDate(client.dateOfLoss)}</div></div>
      <div class="cs-field"><div class="cs-label">Statute of Limitations</div><div class="cs-value">${formatDate(client.statuteOfLimitations)}${solDays!==null&&solDays>=0?` <strong>(${solDays}d)</strong>`:''}</div></div>
      <div class="cs-field"><div class="cs-label">Lead</div><div class="cs-value">${atty?escapeHtml(atty.name):'â€”'}</div></div>
      <div class="cs-field"><div class="cs-label">Paralegal</div><div class="cs-value">${para?escapeHtml(para.name):'â€”'}</div></div>
    </div>
    ${client.notes?`<div style="margin-top:14px"><div class="cs-label" style="font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-secondary);font-weight:700;margin-bottom:2px">Notes</div><div style="font-size:13px;color:var(--text-secondary)">${escapeHtml(client.notes)}</div></div>`:''}
    ${solDays!==null && solDays>=0 && solDays<=90 && client.status!=='Settled' && client.status!=='Closed' ?
      `<div class="sol-alert ${solDays<=30?'critical':solDays<=60?'warning':'caution'}">âš ï¸ Statute of Limitations expires in <strong>${solDays} days</strong> (${formatDate(client.statuteOfLimitations)})</div>` : ''}
  </div>`;

  // Tasks for this client
  h += `<div style="margin:16px 0 8px"><button class="btn btn-primary btn-sm" onclick="openModal('addTask',null,{clientId:'${client.id}'})">+ Add Task</button></div>`;
  const tasks = filterTasks(getClientTasks(client.id));
  if (tasks.length === 0) {
    h += emptyState('No tasks for this client','Click "+ Add Task" above to create one');
  } else {
    TASK_STATUSES.forEach(s => {
      const group = tasks.filter(t=>t.status===s.id).sort((a,b)=>priorityOrder(a.priority)-priorityOrder(b.priority));
      if (group.length===0) return;
      h += `<div class="task-group-title"><span style="color:${TASK_STATUS_COLORS[s.id]}">â—</span> ${s.label} <span class="group-count">(${group.length})</span></div>`;
      group.forEach(t => { h += taskCardHtml(t); });
    });
  }

  el.innerHTML = h;
  el.querySelectorAll('.task-card').forEach(card => {
    card.addEventListener('click', (e) => {
      if (e.target.closest('.task-check')||e.target.closest('.task-actions')) return;
      openModal('taskDetail', card.dataset.id);
    });
  });
}

// -- BY TEAM MEMBER VIEW --
function renderByAttorneyView(el) {
  const atty = getAssignee(state.selectedAttorneyId);
  if (!atty) { el.innerHTML = emptyState('Team member not found','Select a team member from the sidebar'); return; }

  const tasks = getAttorneyTasks(atty.id);
  const todo = tasks.filter(t=>t.status==='todo').length;
  const inprog = tasks.filter(t=>t.status==='inprogress').length;
  const review = tasks.filter(t=>t.status==='review').length;
  const done = tasks.filter(t=>t.status==='done').length;

  let h = `<div class="attorney-info-card">
    <div class="avatar-lg" style="background:${atty.color}">${escapeHtml(atty.initials)}</div>
    <div class="atty-details">
      <h2>${escapeHtml(atty.name)}</h2>
      <div class="atty-role">${escapeHtml(atty.role)} Â· ${escapeHtml(atty.email||'')}</div>
    </div>
  </div>`;

  h += `<div class="workload-stats">
    <div class="workload-stat"><div class="ws-val" style="color:var(--status-todo)">${todo}</div><div class="ws-label">To Do</div></div>
    <div class="workload-stat"><div class="ws-val" style="color:var(--status-inprogress)">${inprog}</div><div class="ws-label">In Progress</div></div>
    <div class="workload-stat"><div class="ws-val" style="color:var(--status-review)">${review}</div><div class="ws-label">Review</div></div>
    <div class="workload-stat"><div class="ws-val" style="color:var(--status-done)">${done}</div><div class="ws-label">Done</div></div>
  </div>`;

  // Client board (filtered to this team member's tasks â€” includes tasks with subtasks assigned to them)
  h += '<div id="attyBoardContainer"></div>';

  // Weekly timeline
  const today = todayStr();
  const activeTasks = tasks.filter(t => t.status !== 'done');
  const overdue = activeTasks.filter(t => t.dueDate && t.dueDate < today).sort((a,b) => a.dueDate.localeCompare(b.dueDate));
  const dueToday = activeTasks.filter(t => t.dueDate === today);
  const dueWeek = activeTasks.filter(t => {
    if (!t.dueDate || t.dueDate <= today) return false;
    const days = daysUntilDate(t.dueDate);
    return days >= 1 && days <= 7;
  }).sort((a,b) => a.dueDate.localeCompare(b.dueDate));
  const upcoming = activeTasks.filter(t => {
    if (!t.dueDate) return true;
    return daysUntilDate(t.dueDate) > 7;
  }).sort((a,b) => (a.dueDate||'9999').localeCompare(b.dueDate||'9999'));

  h += '<div class="weekly-timeline">';
  h += '<h3 style="font-size:16px;font-weight:700;margin-bottom:12px">Weekly Timeline</h3>';

  const sections = [
    { key: 'overdue', label: 'Overdue', tasks: overdue, cls: 'overdue' },
    { key: 'today', label: 'Due Today', tasks: dueToday, cls: 'today' },
    { key: 'week', label: 'Due This Week', tasks: dueWeek, cls: 'week' },
    { key: 'upcoming', label: 'Upcoming', tasks: upcoming, cls: 'upcoming' }
  ];

  sections.forEach(sec => {
    if (sec.tasks.length === 0) return;
    h += `<div class="timeline-section">
      <div class="timeline-section-header ${sec.cls}">${sec.label} <span class="section-count">(${sec.tasks.length})</span></div>`;
    sec.tasks.forEach(t => { h += taskCardWithSubtasksHtml(t); });
    h += '</div>';
  });

  if (activeTasks.length === 0) {
    h += '<div style="padding:20px;text-align:center;color:var(--text-secondary)">No active tasks</div>';
  }

  h += '</div>';

  el.innerHTML = h;

  // Render the client board into the container
  const boardContainer = document.getElementById('attyBoardContainer');
  if (boardContainer) renderBoardView(boardContainer, atty.id);

  el.querySelectorAll('.task-card').forEach(card => {
    card.addEventListener('click', (e) => {
      if (e.target.closest('.task-check')||e.target.closest('.task-actions')) return;
      openModal('taskDetail', card.dataset.id);
    });
  });
}

// =========================================
// 9. MODAL SYSTEM
// =========================================
function openModal(type, entityId, extra) {
  state.modal = {type, entityId, extra};
  renderModal();
  document.getElementById('modalBackdrop').classList.add('open');
}

function closeModal() {
  state.modal = {type:null,entityId:null};
  document.getElementById('modalBackdrop').classList.remove('open');
}

function renderModal() {
  switch(state.modal.type) {
    case 'taskDetail': renderTaskDetailModal(); break;
    case 'addTask': renderAddTaskModal(); break;
    case 'addClient': renderAddClientModal(); break;
    case 'editClient': renderEditClientModal(); break;
    case 'addAttorney': renderAddAttorneyStaffModal(); break;
    case 'addAdminTask': renderAddAdminTaskModal(); break;
    default: return;
  }
}

// -- TASK DETAIL MODAL --
function renderTaskDetailModal() {
  const t = state.tasks.find(x=>x.id===state.modal.entityId);
  if (!t) { closeModal(); return; }
  const modal = document.getElementById('modal');
  if (!t.subtasks) t.subtasks = [];

  const clientOpts = state.clients.map(c=>`<option value="${c.id}" ${t.clientId===c.id?'selected':''}>${escapeHtml(c.name)}</option>`).join('');
  const assigneeOpts = `<option value="">Unassigned</option>
    <optgroup label="Attorneys">${state.attorneys.map(a=>`<option value="${a.id}" ${t.assignedToId===a.id?'selected':''}>${escapeHtml(a.name)}</option>`).join('')}</optgroup>
    <optgroup label="Staff">${state.staff.map(s=>`<option value="${s.id}" ${t.assignedToId===s.id?'selected':''}>${escapeHtml(s.name)}</option>`).join('')}</optgroup>`;
  const statusOpts = TASK_STATUSES.map(s=>`<option value="${s.id}" ${t.status===s.id?'selected':''}>${s.label}</option>`).join('');
  const prioOpts = PRIORITIES.map(p=>`<option value="${p.id}" ${t.priority===p.id?'selected':''}>${p.label}</option>`).join('');
  const taskCats = t.isAdmin ? ADMIN_TASK_CATEGORIES : TASK_CATEGORIES;
  const catOpts = taskCats.map(c=>`<option value="${c}" ${t.category===c?'selected':''}>${c}</option>`).join('');

  // Build subtask assignee options (reusable)
  const stAssigneeOpts = `<option value="">Unassigned</option>
    <optgroup label="Attorneys">${state.attorneys.map(a=>`<option value="${a.id}">${escapeHtml(a.name)}</option>`).join('')}</optgroup>
    <optgroup label="Staff">${state.staff.map(s=>`<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('')}</optgroup>`;

  // Subtasks section
  const subsDone = t.subtasks.filter(s=>s.completed).length;
  const subsTotal = t.subtasks.length;
  let subtasksHtml = `<div class="subtask-section">
    <div class="subtask-header">
      <h4>Subtasks</h4>
      ${subsTotal > 0 ? `<span class="subtask-progress">${subsDone}/${subsTotal} completed</span>` : ''}
    </div>
    <div id="subtaskList">`;

  t.subtasks.forEach((st, idx) => {
    const stAs = getAssignee(st.assignedToId);
    subtasksHtml += `<div class="subtask-row ${st.completed?'completed':''}" data-st-idx="${idx}">
      <div class="subtask-check ${st.completed?'checked':''}" onclick="toggleSubtask('${t.id}',${idx})">${st.completed?'âœ“':''}</div>
      <span class="subtask-title">${escapeHtml(st.title)}</span>
      ${st.link ? `<a class="subtask-link" href="${escapeHtml(sanitizeUrl(st.link))}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" title="${escapeHtml(st.link)}">ðŸ”—</a>` : ''}
      ${stAs ? `<span class="subtask-assignee">${escapeHtml(stAs.name)}</span>` : ''}
      ${st.dueDate ? `<span class="subtask-due ${dueDateClass(st.dueDate)}">${dueDateLabel(st.dueDate)}</span>` : ''}
      <span class="subtask-delete" onclick="deleteSubtask('${t.id}',${idx})" title="Remove">âœ•</span>
    </div>`;
  });

  subtasksHtml += `</div>
    <button class="add-subtask-btn" onclick="showAddSubtaskRow('${t.id}')">+ Add Subtask</button>
    <div id="addSubtaskForm" style="display:none;margin-top:8px">
      <div style="display:flex;flex-direction:column;gap:6px">
        <input class="form-input" id="stTitle" placeholder="Subtask title...">
        <div style="display:flex;gap:6px">
          <input class="form-input" id="stLink" placeholder="Link (optional)" style="flex:1">
          <select class="form-select" id="stAssignee" style="flex:1">${stAssigneeOpts}</select>
          <input class="form-input" type="date" id="stDueDate" style="flex:1">
        </div>
        <div style="display:flex;gap:6px;justify-content:flex-end">
          <button class="btn btn-secondary btn-sm" onclick="hideAddSubtaskRow()">Cancel</button>
          <button class="btn btn-primary btn-sm" onclick="addSubtask('${t.id}')">Add</button>
        </div>
      </div>
    </div>
  </div>`;

  modal.innerHTML = `
    <div class="modal-header"><h3>Task Details</h3><button class="modal-close" onclick="closeModal()">âœ•</button></div>
    <div class="modal-body" style="max-height:70vh;overflow-y:auto">
      <div class="form-group"><label class="form-label">Title</label><input class="form-input" id="mdTitle" value="${escapeHtml(t.title)}"></div>
      <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="mdDesc">${escapeHtml(t.description||'')}</textarea></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="mdStatus">${statusOpts}</select></div>
        <div class="form-group"><label class="form-label">Priority</label><select class="form-select" id="mdPriority">${prioOpts}</select></div>
      </div>
      <div class="form-row">
        ${t.isAdmin
          ? `<div class="form-group"><label class="form-label">Type</label><input class="form-input" value="Admin Task" disabled></div>`
          : `<div class="form-group"><label class="form-label">Client</label><select class="form-select" id="mdClient"><option value="">None</option>${clientOpts}</select></div>`
        }
        <div class="form-group"><label class="form-label">Category</label><select class="form-select" id="mdCategory">${catOpts}</select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Assigned To</label><select class="form-select" id="mdAssignee">${assigneeOpts}</select></div>
        <div class="form-group"><label class="form-label">Due Date</label><input class="form-input" type="date" id="mdDueDate" value="${t.dueDate||''}"></div>
      </div>
      <div style="font-size:12px;color:var(--text-secondary);margin-top:8px">Created: ${new Date(t.createdAt).toLocaleDateString()} ${t.completedAt?'Â· Completed: '+new Date(t.completedAt).toLocaleDateString():''}</div>
      ${subtasksHtml}
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger btn-sm" onclick="if(confirm('Delete this task?')){deleteTask('${t.id}');closeModal();}">Delete</button>
      <div class="footer-right">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveTaskDetail('${t.id}')">Save</button>
      </div>
    </div>
  `;
}

// -- SUBTASK FUNCTIONS --
function toggleSubtask(taskId, idx) {
  const t = state.tasks.find(x=>x.id===taskId);
  if (!t || !t.subtasks || !t.subtasks[idx]) return;
  t.subtasks[idx].completed = !t.subtasks[idx].completed;
  fsSet('tasks', taskId, t);
  renderTaskDetailModal();
  render();
}

function deleteSubtask(taskId, idx) {
  const t = state.tasks.find(x=>x.id===taskId);
  if (!t || !t.subtasks) return;
  t.subtasks.splice(idx, 1);
  fsSet('tasks', taskId, t);
  renderTaskDetailModal();
  render();
}

function showAddSubtaskRow(taskId) {
  document.getElementById('addSubtaskForm').style.display = 'block';
  document.querySelector('.add-subtask-btn').style.display = 'none';
  setTimeout(() => document.getElementById('stTitle').focus(), 50);
}

function hideAddSubtaskRow() {
  document.getElementById('addSubtaskForm').style.display = 'none';
  document.querySelector('.add-subtask-btn').style.display = '';
}

function addSubtask(taskId) {
  const title = document.getElementById('stTitle').value.trim();
  if (!title) { document.getElementById('stTitle').focus(); return; }
  const t = state.tasks.find(x=>x.id===taskId);
  if (!t) return;
  if (!t.subtasks) t.subtasks = [];
  t.subtasks.push({
    id: uid('st'),
    title,
    link: document.getElementById('stLink').value.trim(),
    assignedToId: document.getElementById('stAssignee').value,
    dueDate: document.getElementById('stDueDate').value,
    completed: false
  });
  fsSet('tasks', taskId, t);
  renderTaskDetailModal();
  render();
}

function saveTaskDetail(id) {
  const t = state.tasks.find(x=>x.id===id);
  if (!t) { closeModal(); return; }
  const data = {
    title: document.getElementById('mdTitle').value.trim() || 'Untitled',
    description: document.getElementById('mdDesc').value,
    status: document.getElementById('mdStatus').value,
    priority: document.getElementById('mdPriority').value,
    category: document.getElementById('mdCategory').value,
    assignedToId: document.getElementById('mdAssignee').value,
    dueDate: document.getElementById('mdDueDate').value
  };
  if (!t.isAdmin) {
    const clientEl = document.getElementById('mdClient');
    if (clientEl) data.clientId = clientEl.value;
  }
  updateTask(id, data);
  closeModal();
}

// -- ADD TASK MODAL --
function renderAddTaskModal() {
  const modal = document.getElementById('modal');
  const extra = state.modal.extra || {};
  // Support legacy string (date from calendar) or new object format
  const preDate = typeof extra === 'string' ? extra : (extra.date || '');
  const preClient = (typeof extra === 'object' && extra.clientId) ? extra.clientId : (state.selectedClientId || '');
  const preAssignee = (typeof extra === 'object' && extra.assigneeId) ? extra.assigneeId : '';

  const clientOpts = state.clients.map(c=>`<option value="${c.id}" ${preClient===c.id?'selected':''}>${escapeHtml(c.name)}</option>`).join('');
  const assigneeOpts = `<option value="">Unassigned</option>
    <optgroup label="Attorneys">${state.attorneys.map(a=>`<option value="${a.id}" ${preAssignee===a.id?'selected':''}>${escapeHtml(a.name)}</option>`).join('')}</optgroup>
    <optgroup label="Staff">${state.staff.map(s=>`<option value="${s.id}" ${preAssignee===s.id?'selected':''}>${escapeHtml(s.name)}</option>`).join('')}</optgroup>`;
  const statusOpts = TASK_STATUSES.map(s=>`<option value="${s.id}">${s.label}</option>`).join('');
  const prioOpts = PRIORITIES.map(p=>`<option value="${p.id}" ${p.id==='medium'?'selected':''}>${p.label}</option>`).join('');
  const catOpts = TASK_CATEGORIES.map(c=>`<option value="${c}">${c}</option>`).join('');

  modal.innerHTML = `
    <div class="modal-header"><h3>New Task</h3><button class="modal-close" onclick="closeModal()">âœ•</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Title</label><input class="form-input" id="mdTitle" placeholder="Task title..."></div>
      <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="mdDesc" placeholder="Optional details..."></textarea></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="mdStatus">${statusOpts}</select></div>
        <div class="form-group"><label class="form-label">Priority</label><select class="form-select" id="mdPriority">${prioOpts}</select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Client</label><select class="form-select" id="mdClient"><option value="">None</option>${clientOpts}</select></div>
        <div class="form-group"><label class="form-label">Category</label><select class="form-select" id="mdCategory">${catOpts}</select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Assigned To</label><select class="form-select" id="mdAssignee">${assigneeOpts}</select></div>
        <div class="form-group"><label class="form-label">Due Date</label><input class="form-input" type="date" id="mdDueDate" value="${preDate}"></div>
      </div>
    </div>
    <div class="modal-footer">
      <div></div>
      <div class="footer-right">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitAddTask()">Add Task</button>
      </div>
    </div>
  `;
  setTimeout(() => document.getElementById('mdTitle').focus(), 100);
}

function submitAddTask() {
  const title = document.getElementById('mdTitle').value.trim();
  if (!title) { document.getElementById('mdTitle').focus(); return; }
  addTask({
    title,
    description: document.getElementById('mdDesc').value,
    status: document.getElementById('mdStatus').value,
    priority: document.getElementById('mdPriority').value,
    clientId: document.getElementById('mdClient').value,
    category: document.getElementById('mdCategory').value,
    assignedToId: document.getElementById('mdAssignee').value,
    dueDate: document.getElementById('mdDueDate').value
  });
  closeModal();
}

// -- ADD ADMIN TASK MODAL --
function renderAddAdminTaskModal() {
  const modal = document.getElementById('modal');
  const extra = state.modal.extra || {};
  const preStatus = extra.status || 'todo';

  const assigneeOpts = `<option value="">Unassigned</option>
    <optgroup label="Attorneys">${state.attorneys.map(a=>`<option value="${a.id}">${escapeHtml(a.name)}</option>`).join('')}</optgroup>
    <optgroup label="Staff">${state.staff.map(s=>`<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('')}</optgroup>`;
  const statusOpts = TASK_STATUSES.map(s=>`<option value="${s.id}" ${s.id===preStatus?'selected':''}>${s.label}</option>`).join('');
  const prioOpts = PRIORITIES.map(p=>`<option value="${p.id}" ${p.id==='medium'?'selected':''}>${p.label}</option>`).join('');
  const catOpts = ADMIN_TASK_CATEGORIES.map(c=>`<option value="${c}">${c}</option>`).join('');

  modal.innerHTML = `
    <div class="modal-header"><h3>New Admin Task</h3><button class="modal-close" onclick="closeModal()">âœ•</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Title</label><input class="form-input" id="mdTitle" placeholder="Task title..."></div>
      <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="mdDesc" placeholder="Optional details..."></textarea></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="mdStatus">${statusOpts}</select></div>
        <div class="form-group"><label class="form-label">Priority</label><select class="form-select" id="mdPriority">${prioOpts}</select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Category</label><select class="form-select" id="mdCategory">${catOpts}</select></div>
        <div class="form-group"><label class="form-label">Assigned To</label><select class="form-select" id="mdAssignee">${assigneeOpts}</select></div>
      </div>
      <div class="form-group"><label class="form-label">Due Date</label><input class="form-input" type="date" id="mdDueDate"></div>
    </div>
    <div class="modal-footer">
      <div></div>
      <div class="footer-right">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitAddAdminTask()">Add Task</button>
      </div>
    </div>
  `;
  setTimeout(() => document.getElementById('mdTitle').focus(), 100);
}

function submitAddAdminTask() {
  const title = document.getElementById('mdTitle').value.trim();
  if (!title) { document.getElementById('mdTitle').focus(); return; }
  addTask({
    title,
    description: document.getElementById('mdDesc').value,
    status: document.getElementById('mdStatus').value,
    priority: document.getElementById('mdPriority').value,
    clientId: '',
    category: document.getElementById('mdCategory').value,
    assignedToId: document.getElementById('mdAssignee').value,
    dueDate: document.getElementById('mdDueDate').value,
    isAdmin: true
  });
  closeModal();
}

// -- ADD CLIENT MODAL --
function renderAddClientModal() {
  const modal = document.getElementById('modal');
  const attyOpts = state.attorneys.map(a=>`<option value="${a.id}">${escapeHtml(a.name)}</option>`).join('');
  const staffOpts = state.staff.map(s=>`<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('');
  const caseOpts = CASE_TYPES.map(c=>`<option value="${c}">${c}</option>`).join('');
  const statusOpts = CLIENT_STATUSES.map(s=>`<option value="${s}" ${s==='Intake'?'selected':''}>${s}</option>`).join('');

  modal.innerHTML = `
    <div class="modal-header"><h3>New Client</h3><button class="modal-close" onclick="closeModal()">âœ•</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Client Name</label><input class="form-input" id="mdName" placeholder="Full name"></div>
      <div class="form-group"><label class="form-label">Case Number</label><input class="form-input" id="mdCaseNum" placeholder="e.g. PI-2025-007"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Case Type</label><select class="form-select" id="mdCaseType">${caseOpts}</select></div>
        <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="mdStatus">${statusOpts}</select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Date of Loss</label><input class="form-input" type="date" id="mdDateOfLoss"></div>
        <div class="form-group"><label class="form-label">Statute of Limitations</label><input class="form-input" type="date" id="mdSOL"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Assigned Lead</label><select class="form-select" id="mdAttorney"><option value="">None</option>${attyOpts}</select></div>
        <div class="form-group"><label class="form-label">Assigned Paralegal</label><select class="form-select" id="mdParalegal"><option value="">None</option>${staffOpts}</select></div>
      </div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="mdNotes" placeholder="Case details..."></textarea></div>
    </div>
    <div class="modal-footer">
      <div></div>
      <div class="footer-right">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitAddClient()">Add Client</button>
      </div>
    </div>
  `;
  setTimeout(() => document.getElementById('mdName').focus(), 100);
}

function submitAddClient() {
  const name = document.getElementById('mdName').value.trim();
  if (!name) { document.getElementById('mdName').focus(); return; }
  addClient({
    name,
    caseNumber: document.getElementById('mdCaseNum').value.trim(),
    caseType: document.getElementById('mdCaseType').value,
    status: document.getElementById('mdStatus').value,
    dateOfLoss: document.getElementById('mdDateOfLoss').value,
    statuteOfLimitations: document.getElementById('mdSOL').value,
    assignedAttorneyId: document.getElementById('mdAttorney').value,
    assignedParalegalId: document.getElementById('mdParalegal').value,
    notes: document.getElementById('mdNotes').value
  });
  closeModal();
}

// -- EDIT CLIENT MODAL --
function renderEditClientModal() {
  const c = getClient(state.modal.entityId);
  if (!c) { closeModal(); return; }
  const modal = document.getElementById('modal');
  const attyOpts = state.attorneys.map(a=>`<option value="${a.id}" ${c.assignedAttorneyId===a.id?'selected':''}>${escapeHtml(a.name)}</option>`).join('');
  const staffOpts = state.staff.map(s=>`<option value="${s.id}" ${c.assignedParalegalId===s.id?'selected':''}>${escapeHtml(s.name)}</option>`).join('');
  const caseOpts = CASE_TYPES.map(ct=>`<option value="${ct}" ${c.caseType===ct?'selected':''}>${ct}</option>`).join('');
  const statusOpts = CLIENT_STATUSES.map(s=>`<option value="${s}" ${c.status===s?'selected':''}>${s}</option>`).join('');

  modal.innerHTML = `
    <div class="modal-header"><h3>Edit Client</h3><button class="modal-close" onclick="closeModal()">âœ•</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Client Name</label><input class="form-input" id="mdName" value="${escapeHtml(c.name)}"></div>
      <div class="form-group"><label class="form-label">Case Number</label><input class="form-input" id="mdCaseNum" value="${escapeHtml(c.caseNumber)}"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Case Type</label><select class="form-select" id="mdCaseType">${caseOpts}</select></div>
        <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="mdStatus">${statusOpts}</select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Date of Loss</label><input class="form-input" type="date" id="mdDateOfLoss" value="${c.dateOfLoss||''}"></div>
        <div class="form-group"><label class="form-label">Statute of Limitations</label><input class="form-input" type="date" id="mdSOL" value="${c.statuteOfLimitations||''}"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Assigned Lead</label><select class="form-select" id="mdAttorney"><option value="">None</option>${attyOpts}</select></div>
        <div class="form-group"><label class="form-label">Assigned Paralegal</label><select class="form-select" id="mdParalegal"><option value="">None</option>${staffOpts}</select></div>
      </div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="mdNotes">${escapeHtml(c.notes||'')}</textarea></div>
    </div>
    <div class="modal-footer">
      <div></div>
      <div class="footer-right">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitEditClient('${c.id}')">Save</button>
      </div>
    </div>
  `;
}

function submitEditClient(id) {
  updateClient(id, {
    name: document.getElementById('mdName').value.trim() || 'Unnamed',
    caseNumber: document.getElementById('mdCaseNum').value.trim(),
    caseType: document.getElementById('mdCaseType').value,
    status: document.getElementById('mdStatus').value,
    dateOfLoss: document.getElementById('mdDateOfLoss').value,
    statuteOfLimitations: document.getElementById('mdSOL').value,
    assignedAttorneyId: document.getElementById('mdAttorney').value,
    assignedParalegalId: document.getElementById('mdParalegal').value,
    notes: document.getElementById('mdNotes').value
  });
  closeModal();
}

// -- ADD TEAM MEMBER MODAL --
function renderAddAttorneyStaffModal() {
  const modal = document.getElementById('modal');
  const roleOpts = ATTORNEY_ROLES.map(r=>`<option value="${r}">${r}</option>`).join('');
  const staffRoleOpts = STAFF_ROLES.map(r=>`<option value="${r}">${r}</option>`).join('');
  const colorOpts = AVATAR_COLORS.map(c=>`<option value="${c}" style="color:${c}">â¬¤ ${c}</option>`).join('');

  modal.innerHTML = `
    <div class="modal-header"><h3>Add Team Member</h3><button class="modal-close" onclick="closeModal()">âœ•</button></div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Type</label>
        <select class="form-select" id="mdType" onchange="toggleTeamType()">
          <option value="attorney">Attorney</option>
          <option value="staff">Staff</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Full Name</label><input class="form-input" id="mdName" placeholder="Full name"></div>
      <div class="form-group"><label class="form-label">Initials</label><input class="form-input" id="mdInitials" placeholder="e.g. SC" maxlength="3"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="mdEmail" placeholder="email@firm.com"></div>
        <div class="form-group"><label class="form-label">Color</label><select class="form-select" id="mdColor">${colorOpts}</select></div>
      </div>
      <div class="form-group" id="attyRoleGroup"><label class="form-label">Role</label><select class="form-select" id="mdRole">${roleOpts}</select></div>
      <div class="form-group" id="staffRoleGroup" style="display:none"><label class="form-label">Role</label><select class="form-select" id="mdStaffRole">${staffRoleOpts}</select></div>
    </div>
    <div class="modal-footer">
      <div></div>
      <div class="footer-right">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitAddTeamMember()">Add</button>
      </div>
    </div>
  `;
  setTimeout(() => document.getElementById('mdName').focus(), 100);
}

function toggleTeamType() {
  const isStaff = document.getElementById('mdType').value === 'staff';
  document.getElementById('attyRoleGroup').style.display = isStaff ? 'none' : '';
  document.getElementById('staffRoleGroup').style.display = isStaff ? '' : 'none';
}

function submitAddTeamMember() {
  const name = document.getElementById('mdName').value.trim();
  if (!name) { document.getElementById('mdName').focus(); return; }
  const initials = document.getElementById('mdInitials').value.trim().toUpperCase() || name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
  const data = {
    name,
    initials,
    color: document.getElementById('mdColor').value,
    email: document.getElementById('mdEmail').value.trim()
  };

  if (document.getElementById('mdType').value === 'attorney') {
    data.role = document.getElementById('mdRole').value;
    addAttorney(data);
  } else {
    data.role = document.getElementById('mdStaffRole').value;
    addStaffMember(data);
  }
  closeModal();
}

// =========================================
// 10. HELPERS
// =========================================
function emptyState(title, subtitle) {
  return `<div class="empty-state"><div class="empty-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 12l2 2 4-4"/></svg></div><h3>${title}</h3><p>${subtitle}</p></div>`;
}

function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(el._t);
  el._t = setTimeout(() => el.classList.remove('show'), 2000);
}

// =========================================
// 11. THEME & MOBILE
// =========================================
function toggleDarkMode() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-theme') === 'dark';
  html.setAttribute('data-theme', isDark ? 'light' : 'dark');
  localStorage.setItem('pi-theme', isDark ? 'light' : 'dark');
  renderSidebar();
}

function toggleMobileSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  sidebar.classList.toggle('open');
  if (overlay) overlay.classList.toggle('show');
}

// =========================================
// 12. INIT
// =========================================
// Apply saved theme
const savedTheme = localStorage.getItem('pi-theme') ||
  (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
document.documentElement.setAttribute('data-theme', savedTheme);

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeModal();
});

// Load UI state from localStorage (view, filters, sidebar state)
loadUIState();

// Show a loading state then connect to Firestore
document.getElementById('mainContent').innerHTML = '<div class="empty-state"><div class="empty-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4m0 12v4m-7.07-15.07l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/></svg></div><h3>Connecting...</h3><p>Loading data from cloud</p></div>';

// Start real-time listeners â€” they will populate state and call render()
setupRealtimeListeners();
</script>
</body>
</html>
